<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© WhatsApp - POS SA</title>
  <style>
    @font-face {
      font-family: 'Cairo';
      src: url('../../../assets/fonts/Cairo-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Cairo';
      font-weight: 700;
    }

    body {
      background: #f3f4f6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 3px solid #25D366;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-icon {
      width: 48px;
      height: 48px;
      background: #25D366;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .brand-text h1 {
      font-size: 22px;
      color: #1f2937;
    }

    .brand-text p {
      font-size: 13px;
      color: #6b7280;
    }

    .btn-back {
      padding: 10px 24px;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-back:hover {
      background: #2563eb;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 24px;
      transition: all 0.3s;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f3f4f6;
    }

    .card-title {
      font-size: 18px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f9fafb;
      padding: 8px 14px;
      border-radius: 8px;
    }

    .status-text {
      font-size: 14px;
      color: #374151;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-connected {
      background: #22c55e;
    }

    .status-disconnected {
      background: #ef4444;
    }

    .status-connecting {
      background: #f59e0b;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .qr-container {
      min-height: 280px;
      background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
      border: 3px dashed #22c55e;
      border-radius: 12px;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .qr-container img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
    }

    .whatsapp-icon {
      font-size: 56px;
      margin-bottom: 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: #22c55e;
      color: white;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-secondary {
      background: #3b82f6;
      color: white;
    }

    .btn-secondary:hover {
      background: #2563eb;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-group {
      display: flex;
      gap: 16px;
      margin-top: 24px;
    }

    .btn-group button {
      flex: 1;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: #f9fafb;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea.form-input {
      resize: none;
      font-family: inherit;
    }

    .alert {
      padding: 16px 24px;
      border-radius: 12px;
      display: none;
      border: 2px solid;
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      min-width: 350px;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      animation: slideInFromTop 0.4s ease-out;
    }

    .alert-error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #991b1b;
    }

    .alert-success {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #166534;
    }

    @keyframes slideInFromTop {
      from { 
        opacity: 0; 
        transform: translateY(-100px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    @keyframes slideOutToTop {
      from { 
        opacity: 1; 
        transform: translateY(0);
      }
      to { 
        opacity: 0; 
        transform: translateY(-100px);
      }
    }

    .alert.hiding {
      animation: slideOutToTop 0.4s ease-in forwards;
    }

    .info-box {
      padding: 16px;
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-box-title {
      font-size: 14px;
      color: #1e40af;
      margin-bottom: 6px;
    }

    .info-box-text {
      font-size: 13px;
      color: #1e40af;
      line-height: 1.5;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      animation: modalIn 0.3s;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-icon {
      width: 64px;
      height: 64px;
      background: #ef4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 36px;
    }

    .modal-title {
      font-size: 20px;
      color: #111827;
      margin-bottom: 10px;
      text-align: center;
    }

    .modal-text {
      font-size: 14px;
      color: #6b7280;
      text-align: center;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-buttons {
      display: flex;
      gap: 16px;
    }

    .modal-buttons button {
      flex: 1;
    }

    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideInRight 0.4s ease-out;
      max-width: 400px;
    }

    .toast-notification.hidden {
      display: none;
    }

    .toast-notification.hiding {
      animation: slideOutRight 0.4s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Dark Mode Support */
    .dark body {
      background: #000000 !important;
    }

    .dark header {
      background: #0d0d0d !important;
      border-color: #1a1a1a !important;
    }

    .dark .brand-text h1 {
      color: #ffffff !important;
    }

    .dark .brand-text p {
      color: #cccccc !important;
    }

    .dark .card {
      background: #0d0d0d !important;
      border-color: #1a1a1a !important;
    }

    .dark .card-header {
      border-color: #1a1a1a !important;
    }

    .dark .card-title {
      color: #ffffff !important;
    }

    .dark .status-badge {
      background: #1a1a1a !important;
    }

    .dark .status-text {
      color: #ffffff !important;
    }

    .dark .qr-container {
      background: #1a1a1a !important;
      border-color: #333333 !important;
    }

    .dark input,
    .dark textarea,
    .dark select {
      background: #1a1a1a !important;
      border-color: #333333 !important;
      color: #ffffff !important;
    }

    .dark input:focus,
    .dark textarea:focus,
    .dark select:focus {
      border-color: #3b82f6 !important;
    }

    .dark label {
      color: #ffffff !important;
    }

    .dark .stats-grid {
      background: transparent !important;
    }

    .dark .stat-card {
      background: #1a1a1a !important;
      border-color: #333333 !important;
    }

    .dark .stat-number {
      color: #ffffff !important;
    }

    .dark .stat-label {
      color: #cccccc !important;
    }

    .dark .message-list,
    .dark .message-item {
      background: #0d0d0d !important;
      border-color: #1a1a1a !important;
      color: #ffffff !important;
    }

    .dark .message-item:hover {
      background: #1a1a1a !important;
    }

    .dark .message-header,
    .dark .message-body,
    .dark .message-footer {
      color: #ffffff !important;
    }

    .dark .message-time,
    .dark .message-meta {
      color: #999999 !important;
    }

    .dark .alert {
      background: #1a1a1a !important;
      border-color: #333333 !important;
      color: #ffffff !important;
    }

    .dark .alert.success {
      background: #0a1a0a !important;
      border-color: #1a4a1a !important;
      color: #6bff6b !important;
    }

    .dark .alert.error {
      background: #1a0a0a !important;
      border-color: #4a1a1a !important;
      color: #ff6b6b !important;
    }

    .dark .modal-content {
      background: #0d0d0d !important;
      border-color: #1a1a1a !important;
    }

    .dark .modal-header {
      background: #1a1a1a !important;
      color: #ffffff !important;
    }

    .dark .modal-body {
      color: #ffffff !important;
    }

    .dark .btn-secondary,
    .dark .btn-outline {
      background: #1a1a1a !important;
      border-color: #333333 !important;
      color: #ffffff !important;
    }

    .dark .btn-secondary:hover,
    .dark .btn-outline:hover {
      background: #262626 !important;
    }

    .dark .text-gray-600,
    .dark .text-gray-700,
    .dark .text-gray-800 {
      color: #cccccc !important;
    }

    .dark .bg-gray-50,
    .dark .bg-gray-100 {
      background: #1a1a1a !important;
    }

    .dark .border-gray-200,
    .dark .border-gray-300 {
      border-color: #333333 !important;
    }
  </style>
</head>
<body>
  <div id="messagesLimitToast" class="toast-notification hidden">
    <div class="p-4 bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-700 text-white rounded-xl font-black shadow-2xl" style="padding: 16px; background: linear-gradient(to right, #ef4444, #dc2626); border: 2px solid #b91c1c; color: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 28px;">âš ï¸</span>
        <div>
          <div id="toastTitle" style="font-size: 18px; font-weight: 900; margin-bottom: 4px;">Ø§Ù†ØªÙ‡Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©!</div>
          <div id="toastSubtitle" style="font-size: 14px; font-weight: 700; opacity: 0.9;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ù„ØªØ¬Ø¯ÙŠØ¯</div>
        </div>
        <button onclick="hideToast()" style="margin-right: auto; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s;">
          <span style="font-size: 24px; color: white;">âœ•</span>
        </button>
      </div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon">ğŸ“±</div>
        <div class="brand-text">
          <h1 id="brandTitle">Ø¥Ø¯Ø§Ø±Ø© WhatsApp</h1>
          <p id="brandDesc">Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </div>
      </div>
      <button id="btnBack" class="btn-back" onclick="window.location.href='../main/index.html'">
        â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>
  </header>

  <div class="container">
    <div id="errorDiv" class="alert alert-error" style="justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span>âŒ</span>
        <span id="errorText"></span>
      </div>
      <button onclick="setError('')" style="background: none; border: none; color: #991b1b; font-size: 20px; cursor: pointer;">âœ•</button>
    </div>

    <div id="successDiv" class="alert alert-success" style="justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span>âœ…</span>
        <span id="successText"></span>
      </div>
      <button onclick="setSuccess('')" style="background: none; border: none; color: #166534; font-size: 20px; cursor: pointer;">âœ•</button>
    </div>

    <div id="messagesCounterBanner" style="margin-bottom: 24px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
        <div style="background: linear-gradient(to bottom right, #3b82f6, #2563eb); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 16px; color: white;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 24px;">ğŸ“Š</span>
            <div id="totalBadge" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          </div>
          <div style="text-align: center;">
            <div id="totalMessages" style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">-</div>
            <div id="totalLabel" style="font-size: 12px; font-weight: 700; opacity: 0.9;">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
          </div>
        </div>

        <div id="remainingCard" style="background: linear-gradient(to bottom right, #a855f7, #9333ea); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 16px; color: white;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 24px;">ğŸ’¬</span>
            <div id="remainingBadge" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div style="text-align: center;">
            <div id="remainingMessages" style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">-</div>
            <div id="remainingLabel" style="font-size: 12px; font-weight: 700; opacity: 0.9;">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          </div>
        </div>

        <div style="background: linear-gradient(to bottom right, #10b981, #059669); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 16px; color: white;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 24px;">âœ…</span>
            <div id="sentBadge" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700;">Ù…ÙØ±Ø³Ù„</div>
          </div>
          <div style="text-align: center;">
            <div id="sentMessages" style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">-</div>
            <div id="sentLabel" style="font-size: 12px; font-weight: 700; opacity: 0.9;">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <div class="card">
        <div class="card-header">
          <h2 id="connCardTitle" class="card-title">
            <span>ğŸ”—</span>
            Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
          </h2>
          <div class="status-badge">
            <span id="statusText" class="status-text">ØºÙŠØ± Ù…ØªØµÙ„</span>
            <span id="statusIndicator" class="status-indicator status-disconnected"></span>
          </div>
        </div>

        <div id="qrSection">
          <div class="qr-container" id="qrContainer">
            <div>
              <div class="whatsapp-icon">ğŸ“±</div>
              <p id="qrInitText" style="color: #6b7280; font-size: 15px; margin-bottom: 20px;">
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø±Ø¨Ø· WhatsApp" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
              </p>
              <button id="btnConnect" class="btn btn-primary" onclick="initializeWhatsApp()">
                ğŸš€ Ø±Ø¨Ø· WhatsApp Ø§Ù„Ø¢Ù†
              </button>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button id="btnRefreshStatus" class="btn btn-secondary" onclick="checkStatus()">
            ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
          </button>
          <button id="btnLogout" class="btn btn-danger" onclick="logout()">
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
          </button>
        </div>
      </div>

      <div class="card">
        <h2 id="testCardTitle" class="card-title" style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6;">
          <span>ğŸ“¤</span>
          Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        </h2>

        <div class="form-group">
          <label id="testPhoneLabel" class="form-label">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input type="text" id="testPhone" class="form-input" 
                 placeholder="05xxxxxxxx Ø£Ùˆ 9665xxxxxxxx">
          <p id="testPhoneHelp" class="help-text">ğŸ’¡ Ù…Ø«Ø§Ù„: 0501234567 Ø£Ùˆ 966501234567</p>
        </div>

        <div class="form-group">
          <label id="testMessageLabel" class="form-label">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea id="testMessage" rows="4" class="form-input"
                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©..."></textarea>
        </div>

        <button id="btnSendTest" class="btn btn-primary" style="width: 100%; margin-bottom: 24px;" onclick="sendTestMessage()">
          ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        </button>

        <div class="info-box">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 24px;">ğŸ’¡</span>
            <div>
              <h3 id="infoBoxTitle" class="info-box-title">Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©</h3>
              <p id="infoBoxText" class="info-box-text">
                Ø¨Ø¹Ø¯ Ø±Ø¨Ø· WhatsApp Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ…Ù„ÙØ§Øª PDF Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="logoutModal" class="modal-overlay" onclick="if(event.target === this) closeLogoutModal()">
    <div class="modal-content">
      <div class="modal-icon">âš ï¸</div>
      <h2 id="logoutModalTitle" class="modal-title">ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h2>
      <p id="logoutModalText" class="modal-text">
        Ø³ÙŠØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
        Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„Ù„Ø±Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </p>
      
      <div class="modal-buttons">
        <button id="btnConfirmLogout" class="btn btn-danger" onclick="confirmLogout()">
          ğŸšª Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
        <button id="btnCancelLogout" class="btn" style="background: #e5e7eb; color: #374151; border: 2px solid #9ca3af;" onclick="closeLogoutModal()">
          âŒ Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>
    </div>
  </div>

  <script>
    let __wpIsAr = true;
    function __t(ar, en){ return __wpIsAr ? ar : en; }
    function __txt(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
    function __btn(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
    function __attr(id, attr, text){ const el = document.getElementById(id); if(el) el.setAttribute(attr, text); }

    function translateUI(isAr){
      __wpIsAr = isAr;
      document.documentElement.lang = isAr ? 'ar' : 'en';
      document.documentElement.dir = isAr ? 'rtl' : 'ltr';
      try{ document.title = isAr ? 'Ø¥Ø¯Ø§Ø±Ø© WhatsApp - POS SA' : 'WhatsApp Management - POS SA'; }catch(_){}

      __txt('brandTitle', isAr ? 'Ø¥Ø¯Ø§Ø±Ø© WhatsApp' : 'WhatsApp Management');
      __txt('brandDesc', isAr ? 'Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' : 'Connect your WhatsApp account to send invoices automatically');
      __btn('btnBack', isAr ? 'â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'â¬… Back to Home');

      __txt('totalBadge', isAr ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total');
      __txt('totalLabel', isAr ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„' : 'Messages');
      __txt('remainingBadge', isAr ? 'Ù…ØªØ¨Ù‚ÙŠ' : 'Remaining');
      __txt('remainingLabel', isAr ? 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©' : 'Remaining Messages');
      __txt('sentBadge', isAr ? 'Ù…ÙØ±Ø³Ù„' : 'Sent');
      __txt('sentLabel', isAr ? 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©' : 'Used Messages');

      const connTitle = document.getElementById('connCardTitle');
      if(connTitle){ const sp = connTitle.querySelector('span'); connTitle.childNodes[connTitle.childNodes.length-1].textContent = ' ' + (isAr ? 'Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection Status'); }
      __txt('statusText', isAr ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'Disconnected');
      __txt('qrInitText', isAr ? 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø±Ø¨Ø· WhatsApp" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Click "Connect WhatsApp" to start');
      __btn('btnConnect', isAr ? 'ğŸš€ Ø±Ø¨Ø· WhatsApp Ø§Ù„Ø¢Ù†' : 'ğŸš€ Connect WhatsApp Now');
      __btn('btnRefreshStatus', isAr ? 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©' : 'ğŸ”„ Refresh Status');
      __btn('btnLogout', isAr ? 'ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬' : 'ğŸšª Logout');

      const testTitle = document.getElementById('testCardTitle');
      if(testTitle){ const sp = testTitle.querySelector('span'); testTitle.childNodes[testTitle.childNodes.length-1].textContent = ' ' + (isAr ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Send Test'); }
      __txt('testPhoneLabel', isAr ? 'ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„' : 'ğŸ“ Phone Number');
      __attr('testPhone', 'placeholder', isAr ? '05xxxxxxxx Ø£Ùˆ 9665xxxxxxxx' : '05xxxxxxxx or 9665xxxxxxxx');
      __txt('testPhoneHelp', isAr ? 'ğŸ’¡ Ù…Ø«Ø§Ù„: 0501234567 Ø£Ùˆ 966501234567' : 'ğŸ’¡ Example: 0501234567 or 966501234567');
      __txt('testMessageLabel', isAr ? 'ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©' : 'ğŸ’¬ Message');
      __attr('testMessage', 'placeholder', isAr ? 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©...' : 'Write a test message...');
      __btn('btnSendTest', isAr ? 'ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©' : 'ğŸš€ Send Test Message');
      __txt('infoBoxTitle', isAr ? 'Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©' : 'Important Note');
      __txt('infoBoxText', isAr ? 'Ø¨Ø¹Ø¯ Ø±Ø¨Ø· WhatsApp Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ…Ù„ÙØ§Øª PDF Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.' : 'After connecting WhatsApp successfully, invoices will be sent automatically as PDF files to customers according to settings.');

      __txt('logoutModalTitle', isAr ? 'ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' : 'Confirm Logout');
      __txt('logoutModalText', isAr ? 'Ø³ÙŠØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„Ù„Ø±Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' : 'The connection will be disconnected and all current session data will be deleted. You will need to scan the QR code again to reconnect.');
      __btn('btnConfirmLogout', isAr ? 'ğŸšª Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' : 'ğŸšª Yes, Logout');
      __btn('btnCancelLogout', isAr ? 'âŒ Ø¥Ù„ØºØ§Ø¡' : 'âŒ Cancel');

      __txt('toastTitle', isAr ? 'Ø§Ù†ØªÙ‡Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©!' : 'Message limit reached!');
      __txt('toastSubtitle', isAr ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ù„ØªØ¬Ø¯ÙŠØ¯' : 'Please contact technical support to renew');
    }

    let qrCheckInterval = null;
    let toastTimeout = null;
    let toastShownOnLoad = false;

    function showToast() {
      const toast = document.getElementById('messagesLimitToast');
      toast.classList.remove('hidden', 'hiding');
      
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      
      toastTimeout = setTimeout(() => {
        hideToast();
      }, 8000);
    }

    function hideToast() {
      const toast = document.getElementById('messagesLimitToast');
      toast.classList.add('hiding');
      
      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('hiding');
      }, 400);
      
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
    }

    async function loadMessagesStats(isInitialLoad = false) {
      try {
        console.log('Loading messages stats...');
        const result = await window.api.whatsapp_get_messages_stats();
        console.log('Messages stats result:', result);
        
        if (result && result.success) {
          const { limit, sent, remaining } = result;
          console.log(`Stats - Limit: ${limit}, Sent: ${sent}, Remaining: ${remaining}`);
          
          document.getElementById('remainingMessages').textContent = remaining !== undefined ? remaining : '-';
          document.getElementById('totalMessages').textContent = limit !== undefined ? limit : '-';
          document.getElementById('sentMessages').textContent = sent !== undefined ? sent : '-';
          
          const remainingCard = document.getElementById('remainingCard');
          if (remaining !== undefined) {
            if (remaining <= 10 && remaining > 0) {
              remainingCard.style.background = 'linear-gradient(to bottom right, #f97316, #ea580c)';
            } else if (remaining <= 0) {
              remainingCard.style.background = 'linear-gradient(to bottom right, #ef4444, #dc2626)';
              if (isInitialLoad && !toastShownOnLoad) {
                showToast();
                toastShownOnLoad = true;
              }
            } else {
              remainingCard.style.background = 'linear-gradient(to bottom right, #a855f7, #9333ea)';
            }
          }
        } else {
          console.error('Failed to load stats:', result ? result.error : 'No result returned');
          document.getElementById('remainingMessages').textContent = '0';
          document.getElementById('totalMessages').textContent = '0';
          document.getElementById('sentMessages').textContent = '0';
        }
      } catch (error) {
        console.error('Error loading messages stats:', error);
        const errTxt = __t('Ø®Ø·Ø£', 'Error');
        document.getElementById('remainingMessages').textContent = errTxt;
        document.getElementById('totalMessages').textContent = errTxt;
        document.getElementById('sentMessages').textContent = errTxt;
      }
    }

    let errorTimeout = null;
    let successTimeout = null;

    function setError(msg) {
      const errorDiv = document.getElementById('errorDiv');
      const errorText = document.getElementById('errorText');
      
      if (errorTimeout) {
        clearTimeout(errorTimeout);
      }
      
      if (msg) {
        errorText.textContent = msg;
        errorDiv.classList.remove('hiding');
        errorDiv.style.display = 'flex';
        
        errorTimeout = setTimeout(() => {
          errorDiv.classList.add('hiding');
          setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.classList.remove('hiding');
          }, 400);
        }, 5000);
      } else {
        errorDiv.classList.add('hiding');
        setTimeout(() => {
          errorDiv.style.display = 'none';
          errorDiv.classList.remove('hiding');
        }, 400);
      }
    }

    function setSuccess(msg) {
      const successDiv = document.getElementById('successDiv');
      const successText = document.getElementById('successText');
      
      if (successTimeout) {
        clearTimeout(successTimeout);
      }
      
      if (msg) {
        successText.textContent = msg;
        successDiv.classList.remove('hiding');
        successDiv.style.display = 'flex';
        
        successTimeout = setTimeout(() => {
          successDiv.classList.add('hiding');
          setTimeout(() => {
            successDiv.style.display = 'none';
            successDiv.classList.remove('hiding');
          }, 400);
        }, 5000);
      } else {
        successDiv.classList.add('hiding');
        setTimeout(() => {
          successDiv.style.display = 'none';
          successDiv.classList.remove('hiding');
        }, 400);
      }
    }

    function updateStatus(connected, state = '') {
      const statusText = document.getElementById('statusText');
      const statusIndicator = document.getElementById('statusIndicator');
      
      if (connected) {
        statusText.textContent = __t('Ù…ØªØµÙ„', 'Connected');
        statusText.style.color = '#166534';
        statusIndicator.className = 'status-indicator status-connected';
        setSuccess(__t('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ø¨Ø± WhatsApp', 'Connected successfully! You can now send invoices via WhatsApp'));
      } else {
        if (state === 'connecting') {
          statusText.textContent = __t('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'Connecting...');
          statusText.style.color = '#d97706';
          statusIndicator.className = 'status-indicator status-connecting';
        } else {
          statusText.textContent = __t('ØºÙŠØ± Ù…ØªØµÙ„', 'Disconnected');
          statusText.style.color = '#991b1b';
          statusIndicator.className = 'status-indicator status-disconnected';
        }
      }
    }

    async function checkStatus() {
      try {
        if(!navigator.onLine){
          updateStatus(false);
          setError(__t('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - WhatsApp ØºÙŠØ± Ù…ØªØµÙ„', 'âŒ No internet connection - WhatsApp is disconnected'));
          return;
        }
        
        const result = await window.api.whatsapp_status();
        if (result.success) {
          updateStatus(result.connected);
          if(result.connected){
            setSuccess(__t('âœ… WhatsApp Ù…ØªØµÙ„ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ', 'âœ… WhatsApp is connected and working normally'));
          }
        } else {
          updateStatus(false);
        }
      } catch (error) {
        setError(__t('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©: ', 'Error checking status: ') + (error.message || error));
        updateStatus(false);
      }
    }

    function startQRPolling() {
      if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
      }
      
      qrCheckInterval = setInterval(async () => {
        try {
          const qrResult = await window.api.whatsapp_get_qr();
          
          if (qrResult.success && qrResult.qr) {
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = `
              <div style="text-align: center;">
                <p style="color: #166534; margin-bottom: 14px; font-size: 16px;">ğŸ“± ${__t('Ø§Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ WhatsApp', 'Scan this QR code with WhatsApp app')}</p>
                <img src="${qrResult.qr}" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <p style="color: #6b7280; margin-top: 14px; font-size: 13px;">â± ${__t('ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†', 'Expires in 2 minutes')}</p>
              </div>
            `;
          }

          const statusResult = await window.api.whatsapp_status();
          if (statusResult.success && statusResult.connected) {
            clearInterval(qrCheckInterval);
            updateStatus(true);
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = `
              <div style="text-align: center;">
                <div style="font-size: 72px; margin-bottom: 20px;">âœ…</div>
                <p style="color: #166534; font-size: 24px; margin-bottom: 10px;">${__t('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'Connected successfully!')}</p>
                <p style="color: #6b7280; font-size: 15px;">${__t('WhatsApp Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¢Ù†', 'WhatsApp is ready to use now')}</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('QR polling error:', error);
        }
      }, 2000);
    }

    async function initializeWhatsApp() {
      try {
        setError('');
        setSuccess('');
        
        if(!navigator.onLine){
          setError(__t('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'âŒ No internet connection! Please check your device internet connection and try again.'));
          return;
        }
        
        updateStatus(false, 'connecting');
        
        const qrContainer = document.getElementById('qrContainer');
        qrContainer.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 56px; margin-bottom: 14px; animation: spin 1s linear infinite;">â³</div>
            <p style="color: #6b7280; font-size: 15px;">${__t('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...', 'Initializing and closing previous sessions...')}</p>
          </div>
        `;

        setSuccess(__t('â³ Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Chrome ÙˆØ§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„...', 'â³ Closing Chrome and preparing to connect...'));
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        qrContainer.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 56px; margin-bottom: 14px; animation: spin 1s linear infinite;">â³</div>
            <p style="color: #6b7280; font-size: 15px;">${__t('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WhatsApp...', 'Connecting to WhatsApp server...')}</p>
          </div>
        `;

        startQRPolling();

        setSuccess(__t('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù†ØªØ¸Ø± Ø¸Ù‡ÙˆØ± Ø±Ù…Ø² QR...', 'Connection started, waiting for QR code...'));
        
        window.api.whatsapp_initialize().then(result => {
          if (!result.success) {
            setError(__t('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ', 'Initialization error: ') + (result.error || __t('ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'Initialization failed')));
            qrContainer.innerHTML = `
              <div>
                <div class="whatsapp-icon">âŒ</div>
                <p style="color: #dc2626; font-size: 15px; margin-bottom: 20px;">
                  ${__t('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'Connection failed, try again')}
                </p>
                <button class="btn btn-primary" onclick="initializeWhatsApp()">
                  ğŸ”„ ${__t('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'Retry')}
                </button>
              </div>
            `;
          }
        }).catch(error => {
          setError(__t('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ', 'Initialization error: ') + (error.message || error));
          qrContainer.innerHTML = `
            <div>
              <div class="whatsapp-icon">âŒ</div>
              <p style="color: #dc2626; font-size: 15px; margin-bottom: 20px;">
                ${__t('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'Connection failed, try again')}
              </p>
              <button class="btn btn-primary" onclick="initializeWhatsApp()">
                ğŸ”„ ${__t('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'Retry')}
              </button>
            </div>
          `;
        });

      } catch (error) {
        setError(__t('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ', 'Initialization error: ') + (error.message || error));
        updateStatus(false);
      }
    }

    async function sendTestMessage() {
      try {
        setError('');
        setSuccess('');

        if(!navigator.onLine){
          setError(__t('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'âŒ No internet connection! Please check your device internet connection and try again.'));
          return;
        }

        const phone = document.getElementById('testPhone').value.trim();
        const message = document.getElementById('testMessage').value.trim();

        if (!phone) {
          setError(__t('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹', 'âš ï¸ Please enter a phone number first'));
          return;
        }

        if (!message) {
          setError(__t('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'âš ï¸ Please write a message first'));
          return;
        }

        setSuccess(__t('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...', 'â³ Sending message...'));

        const result = await window.api.whatsapp_send_text(phone, message);
        
        if (result.success) {
          setSuccess(__t('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'âœ… Message sent successfully!'));
          document.getElementById('testMessage').value = '';
          await loadMessagesStats();
        } else {
          if (result.limitReached) {
            showToast();
            await loadMessagesStats();
          } else {
            setError(__t('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ', 'âŒ Send failed: ') + (result.error || __t('Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'Unknown error')));
          }
        }
      } catch (error) {
        console.error(error);
        setError(__t('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ', 'âŒ Send error: ') + (error.message || error));
      }
    }

    function logout() {
      document.getElementById('logoutModal').classList.add('active');
    }

    function closeLogoutModal() {
      document.getElementById('logoutModal').classList.remove('active');
    }

    async function confirmLogout() {
      closeLogoutModal();
      
      try {
        setError('');
        setSuccess(__t('â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©...', 'â³ Logging out and deleting session data...'));
        
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
          qrCheckInterval = null;
        }
        
        const result = await window.api.whatsapp_logout();
        
        if (result.success) {
          setSuccess(__t('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...', 'âœ… Logged out successfully and all session data deleted. Reloading page...'));
          updateStatus(false);
          
          const qrContainer = document.getElementById('qrContainer');
          qrContainer.innerHTML = `
            <div>
              <div class="whatsapp-icon">ğŸ“±</div>
              <p style="color: #6b7280; font-size: 15px; margin-bottom: 20px;">
                ${__t('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø±Ø¨Ø· WhatsApp" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„', 'Click "Connect WhatsApp" to start')}
              </p>
              <button class="btn btn-primary" onclick="initializeWhatsApp()">
                ğŸš€ ${__t('Ø±Ø¨Ø· WhatsApp Ø§Ù„Ø¢Ù†', 'Connect WhatsApp Now')}
              </button>
            </div>
          `;
          
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          setError(__t('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ', 'âŒ Logout failed: ') + (result.error || __t('Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'Unknown error')));
        }
      } catch (error) {
        setError(__t('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ', 'âŒ Logout error: ') + (error.message || error));
      }
    }

    checkStatus();

    setTimeout(() => {
      console.log('Calling loadMessagesStats...');
      loadMessagesStats(true);
    }, 500);

    setInterval(loadMessagesStats, 30000);

    (function initLocale(){
      (async ()=>{
        try{
          const res = await window.api.app_get_locale();
          const lang = (res && res.lang) || 'ar';
          const isAr = lang.split('-')[0].toLowerCase() !== 'en';
          translateUI(isAr);
        }catch(_){ translateUI(true); }
      })();
      try{
        window.api.app_on_locale_changed((L)=>{
          const isAr = (typeof L === 'string' ? L.split('-')[0].toLowerCase() : 'ar') !== 'en';
          translateUI(isAr);
          try{ window.__i18n_burst && window.__i18n_burst(L); }catch(_){}
        });
      }catch(_){}
    })();
  </script>

  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  <script src="../theme.js"></script>
</body>
</html>
