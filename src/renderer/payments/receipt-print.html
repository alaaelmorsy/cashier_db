<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ A4</title>
    <style>
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-Black.ttf') format('truetype');
        font-weight: 900;
        font-display: swap;
      }
      @font-face{
        font-family: 'saudi_riyal';
        src: url('../../../assets/fonts/saudi-riyal.woff') format('woff'),
             url('../../../assets/fonts/saudi-riyal.ttf') format('truetype');
        font-display: swap;
        unicode-range: U+E900;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body{ 
        font-family: 'Cairo', 'saudi_riyal', system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Arial, sans-serif; 
        background: #f8fafc;
        color: #000; 
        font-weight: 900;
        font-size: 14px;
        line-height: 1.6;
      }
      
      .page{ 
        width: 210mm; 
        min-height: 297mm; 
        margin: 20px auto; 
        padding: 10mm 8mm;
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .brand-header{
        display:grid;
        grid-template-columns: 1fr auto 1fr;
        align-items:start;
        gap:10px;
        margin-bottom:10px;
      }
      .brand-center{ text-align:center; margin-top:20px; }
      .brand-center img{ width:65px; height:65px; object-fit:contain; border-radius:8px; background:#fff; border:1px solid #cbd5e1; }
      .brand-name{ font-size:18px; font-weight:900; margin-top:3px; }
      .company-box{ background:#eef2ff; border:1px solid #cbd5e1; border-radius:8px; padding:6px; }
      .company-box .row{ display:grid; gap:3px; font-weight:800; color:#0f172a; }
      .company-box .muted{ color:#334155; font-weight:700; font-size:11px; }
      .side-info{ display:grid; gap:4px; align-content: start; }
      .side-info .cell{ display:flex; justify-content:space-between; gap:8px; min-height:32px; align-items:center; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border:2px solid #cbd5e1; border-radius:6px; padding:6px 10px; font-weight:900; font-size:13px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      .side-info .label{ color:#000000; font-size:12px; font-weight:900; }
      .side-info .cell div:last-child{ color:#000000; font-weight:900; }
      .title-line{ text-align:center; margin:5px 0 10px; padding:8px 0; border-top:3px solid #1e40af; border-bottom:3px solid #1e40af; background:linear-gradient(to right, transparent, #dbeafe 20%, #dbeafe 80%, transparent); font-weight:900; color:#1e3a8a; font-size:18px; }
      .content-grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
      .amount-box{ background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border:3px solid #16a34a; border-radius:10px; padding:15px; text-align:center; box-shadow: 0 4px 6px rgba(22, 163, 74, 0.1); }
      .amount-box .label{ color:#15803d; font-weight:900; font-size:14px; margin-bottom:8px; }
      .amount-box .value{ font-size:42px; font-weight:900; color:#166534; margin:8px 0; letter-spacing:1px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .amount-box .currency{ color:#15803d; font-weight:900; font-size:15px; }
      .currency-symbol{ font-family: 'Cairo', 'saudi_riyal', inherit; font-weight:900; }
      .fields{ background:linear-gradient(to bottom, #ffffff, #f8fafc); border:2px solid #cbd5e1; border-radius:10px; padding:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .fields .row-header{ display:flex; justify-content:space-between; gap:12px; padding:10px 12px; margin-bottom:10px; background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border:2px solid #3b82f6; border-radius:8px; font-weight:900; font-size:15px; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); }
      .fields .row-header .label{ color:#000000; font-size:14px; font-weight:900; }
      .fields .row-header div:last-child{ color:#000000; font-weight:900; }
      .fields .grid-container{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:0; /* join cells to show grid lines */
        border:2px solid #cbd5e1;
        border-radius:8px;
        overflow:hidden;
        background:#ffffff;
      }
      .fields .row{
        display:flex; justify-content:space-between; gap:10px;
        padding:10px 12px;
        background:#fbfdff;
        border-top:1px solid #e2e8f0; /* horizontal grid line */
        font-weight:900; font-size:13px; transition: background 0.2s;
      }
      /* vertical grid line between the two columns (RTL/LTR safe) */
      .fields .grid-container .row:nth-child(odd){ border-inline-end:1px solid #e2e8f0; }
      /* remove top border from the first row */
      .fields .grid-container .row:nth-child(-n+2){ border-top:0; }
      .fields .row:hover{ background:#f1f5f9; }
      .fields .label{ color:#000000; min-width:120px; font-size:12px; font-weight:900; }
      .fields .row div:last-child{ color:#000000; font-weight:900; }
      .signature{ display:grid; grid-template-columns: repeat(3,1fr); gap:20px; margin-top:20px; }
      .signature .box{ text-align:center; font-size:13px; font-weight:900; color:#334155; }
      .signature .line{ height:50px; border-bottom:3px solid #cbd5e1; margin-bottom:5px; }
      .footer-mini{ margin-top:15px; padding-top:10px; border-top:2px dashed #cbd5e1; color:#64748b; font-size:11px; font-weight:700; text-align:center; }

      .receipt-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .receipt-title {
        font-size: 32px;
        font-weight: 900;
        color: #1e3a8a;
        margin-bottom: 10px;
        padding: 15px;
        background: linear-gradient(to right, transparent, #e0f2fe 20%, #e0f2fe 80%, transparent);
        border-top: 3px solid #1e3a8a;
        border-bottom: 3px solid #1e3a8a;
      }

      .receipt-number-box {
        display: inline-block;
        margin-top: 15px;
        padding: 12px 30px;
        background: #fef3c7;
        border: 3px solid #f59e0b;
        border-radius: 8px;
        font-size: 24px;
        font-weight: 900;
        color: #92400e;
      }

      .info-container {
        margin: 30px 0;
      }

      .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        border: 3px solid #1e3a8a;
        border-radius: 8px;
        overflow: hidden;
      }

      .info-table thead {
        background: #1e3a8a;
        color: white;
      }

      .info-table thead th {
        padding: 15px;
        font-size: 16px;
        font-weight: 900;
        text-align: center;
      }

      .info-table tbody tr {
        border-bottom: 2px solid #e2e8f0;
      }

      .info-table tbody tr:last-child {
        border-bottom: none;
      }

      .info-table tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .info-table tbody td {
        padding: 15px;
        text-align: center;
        font-weight: 700;
        font-size: 14px;
      }

      .info-label {
        color: #64748b;
        font-size: 13px;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .info-value {
        color: #000;
        font-size: 15px;
        font-weight: 900;
      }

      .amount-container {
        margin: 40px 0;
        padding: 30px;
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border: 4px solid #16a34a;
        border-radius: 12px;
        text-align: center;
      }

      .amount-label {
        font-size: 20px;
        color: #15803d;
        font-weight: 900;
        margin-bottom: 15px;
      }

      .amount-value {
        font-size: 48px;
        color: #166534;
        font-weight: 900;
        letter-spacing: 2px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .amount-text {
        margin-top: 15px;
        font-size: 16px;
        color: #166534;
        font-weight: 700;
        padding: 10px;
        background: rgba(255,255,255,0.5);
        border-radius: 6px;
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 30px 0;
      }

      .detail-box {
        padding: 20px;
        background: #f8fafc;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        border-right: 5px solid #3b82f6;
      }

      .detail-box.full-width {
        grid-column: 1 / -1;
      }

      .detail-title {
        color: #475569;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .detail-content {
        color: #000;
        font-size: 16px;
        font-weight: 900;
      }

      .method-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 900;
        margin-top: 8px;
      }

      .method-cash {
        background: #dcfce7;
        color: #166534;
        border: 2px solid #16a34a;
      }

      .method-card {
        background: #dbeafe;
        color: #1e40af;
        border: 2px solid #2563eb;
      }

      .method-tamara {
        background: #fce7f3;
        color: #9f1239;
        border: 2px solid #e11d48;
      }

      .method-tabby {
        background: #f3e8ff;
        color: #6b21a8;
        border: 2px solid #9333ea;
      }

      .notes-section {
        margin: 30px 0;
        padding: 20px;
        background: #fffbeb;
        border: 2px solid #fbbf24;
        border-right: 5px solid #f59e0b;
        border-radius: 8px;
      }

      .notes-title {
        font-size: 14px;
        color: #92400e;
        font-weight: 900;
        margin-bottom: 10px;
      }

      .notes-content {
        color: #78350f;
        font-weight: 600;
        font-size: 13px;
        line-height: 1.8;
      }

      .signature-section {
        margin-top: 60px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 40px;
      }

      .signature-box {
        text-align: center;
      }

      .signature-title {
        font-weight: 900;
        color: #000;
        margin-bottom: 60px;
        font-size: 14px;
      }

      .signature-line {
        border-bottom: 3px solid #000;
        padding-top: 10px;
      }

      .footer {
        margin-top: 50px;
        padding-top: 20px;
        border-top: 3px dashed #cbd5e1;
        text-align: center;
      }

      .footer-date {
        font-weight: 900;
        color: #000;
        margin-bottom: 10px;
        font-size: 13px;
      }

      .footer-note {
        color: #64748b;
        font-size: 11px;
        font-weight: 600;
      }

      .btn-container {
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .btn-print {
        background: #0b3daa;
        color: white;
      }

      .btn-export {
        background: #16a34a;
        color: white;
      }

      .btn-close {
        background: #64748b;
        color: white;
      }

      @media print {
        @page { 
          size: A4; 
          margin: 8mm; 
        }
        
        body {
          background: white;
        }
        
        .btn-container { 
          display: none !important; 
        }
        
        .page { 
          width: 100%; 
          margin: 0;
          padding: 8mm;
          box-shadow: none;
          min-height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="btn-container">
      <button class="btn btn-print" onclick="window.print()">Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn btn-export" id="exportBtn">ØªØµØ¯ÙŠØ± PDF</button>
      <button class="btn btn-close" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="page">
      <div class="brand-header">
        <div class="side-info">
          <div class="cell"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div id="receiptDate">-</div></div>
          <div class="cell"><div class="label">Ø§Ù„ÙˆÙ‚Øª</div><div id="receiptTime">-</div></div>
          <div class="cell"><div class="label">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</div><div id="receiptNo">-</div></div>
          <div class="cell"><div class="label">Ø§Ù„Ø¹Ù…Ù„Ø©</div><div><span class="currency-symbol">&#xE900;</span></div></div>
        </div>
        <div class="brand-center">
          <img id="logo" alt="Logo" />
        </div>
        <div class="side-info" id="companyInfoAr"></div>
      </div>

      <div class="title-line">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</div>

      <div class="content-grid">
        <div class="fields" id="custFields">
          <!-- Header Row: Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ (Full Width) -->
          <div class="row-header" id="rowName">
            <div class="label">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯</div>
            <div id="customerName">-</div>
          </div>
          
          <!-- Grid Container: Two Columns -->
          <div class="grid-container">
            <div class="row" id="rowAddress"><div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><div id="customerAddress">-</div></div>
            <div class="row" id="rowPhone"><div class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div><div id="customerPhone">-</div></div>
            <div class="row" id="rowEmail" style="display:none"><div class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div><div id="customerEmail">-</div></div>
            <div class="row" id="rowVat" style="display:none"><div class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</div><div id="customerVat">-</div></div>
            <div class="row" id="rowCR" style="display:none"><div class="label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</div><div id="customerCR">-</div></div>
            <div class="row" id="rowNat" style="display:none"><div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ</div><div id="customerNational">-</div></div>
            <div class="row"><div class="label">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©</div><div id="amountWords">-</div></div>
            <div class="row"><div class="label">ÙˆØ°Ù„Ùƒ Ø¹Ù†</div><div id="reason">-</div></div>
            <div class="row"><div class="label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div><div id="invoiceNo">-</div></div>
            <div class="row"><div class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div><div id="paymentMethod">-</div></div>
          </div>
        </div>
        
        <div class="amount-box">
          <div class="label">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
          <div class="value" id="amount">0.00</div>
          <div class="currency">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ <span class="currency-symbol">&#xE900;</span></div>
        </div>
      </div>

      <div class="signature">
        <div class="box"><div class="line"></div>Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
        <div class="box"><div class="line"></div>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
        <div class="box"><div class="line"></div>Ø§Ù„Ù…Ø¯ÙŠØ±</div>
      </div>

      <div class="footer-mini">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="userName">-</span> â€” ØªÙ… Ø§Ù„Ø¥ØµØ¯Ø§Ø±: <span id="printDate">-</span></div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const receiptData = {
        // Support both receipt_no and voucher_no to ensure compatibility
        receiptNo: params.get('receipt_no') || params.get('voucher_no') || '-',
        invoiceNo: params.get('invoice_no') || '-',
        amount: params.get('amount') || '0.00',
        // Support both payment_method and method
        paymentMethod: params.get('payment_method') || params.get('method') || 'cash',
        userName: params.get('user_name') || '-',
        customerId: params.get('customer_id') || null,
        customerName: params.get('customer_name') || null,
        customerPhone: params.get('customer_phone') || null,
        customerEmail: params.get('customer_email') || null,
        customerAddress: params.get('customer_address') || null,
        // Support both customer_vat and customer_tax
        customerVat: params.get('customer_vat') || params.get('customer_tax') || null,
        customerCR: params.get('customer_cr') || null,
        customerNational: params.get('customer_national_address') || null,
        reason: params.get('reason') || null,
        notes: params.get('notes') || null,
        date: params.get('date') || new Date().toISOString()
      };
      const api = (window.opener && window.opener.api) ? window.opener.api : (window.api || {});

      async function loadSettings(){
        try{
          const r = await (api.settings_get ? api.settings_get() : Promise.resolve(null));
          if(r && r.ok && r.item){
            const s = r.item;
            
            const logo = document.getElementById('logo');
            try{
              const lg = api.settings_image_get ? await api.settings_image_get() : null;
              if(lg && lg.ok && lg.base64){
                logo.src = `data:${lg.mime||'image/png'};base64,${lg.base64}`;
                logo.style.display = 'block';
              } else if(s.logo_path){
                if(String(s.logo_path).startsWith('assets/')){
                  logo.src = '../../../' + s.logo_path;
                } else {
                  logo.src = 'file:///' + String(s.logo_path||'').replace(/\\/g,'/');
                }
                logo.style.display = 'block';
              } else {
                logo.style.display = 'none';
              }
              const lw = Number(s.logo_width_px||0), lh = Number(s.logo_height_px||0);
              if(lw>0){ logo.style.width = lw + 'px'; }
              if(lh>0){ logo.style.height = lh + 'px'; }
            }catch(_){ logo.style.display = 'none'; }
            
            const arName = s.seller_legal_name || 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©';
            const cells = [];
            cells.push(`<div class="cell"><div class="label">Ø§Ù„Ø´Ø±ÙƒØ©</div><div>${arName}</div></div>`);
            if(s.company_location){ cells.push(`<div class="cell"><div class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div>${s.company_location}</div></div>`); }
            if(s.mobile){ cells.push(`<div class="cell"><div class="label">Ø§Ù„Ø¬ÙˆØ§Ù„</div><div>${s.mobile}</div></div>`); }
            if(s.seller_vat_number){ cells.push(`<div class="cell"><div class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</div><div>${s.seller_vat_number}</div></div>`); }
            if(s.commercial_register){ cells.push(`<div class="cell"><div class="label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</div><div>${s.commercial_register}</div></div>`); }
            document.getElementById('companyInfoAr').innerHTML = cells.join('');
          }
        }catch(e){
          console.error('Failed to load settings:', e);
        }
      }

      function formatAmount(amount){
        return Number(amount || 0).toFixed(2);
      }

      function formatDate(dateStr){
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function formatTime(dateStr){
        const d = new Date(dateStr);
        let hours = d.getHours();
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const seconds = String(d.getSeconds()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const hoursStr = String(hours).padStart(2, '0');
        return `${hoursStr}:${minutes}:${seconds} ${ampm}`;
      }

      function getPaymentMethodName(method){
        const names = {
          'cash': 'Ù†Ù‚Ø¯ÙŠ / Cash',
          'card': 'Ø¨Ø·Ø§Ù‚Ø© / Card',
          'tamara': 'ØªÙ…Ø§Ø±Ø§ / Tamara',
          'tabby': 'ØªØ§Ø¨ÙŠ / Tabby'
        };
        return names[method] || method;
      }

      function getPaymentMethodBadge(method){
        const badges = {
          'cash': '<span class="method-badge method-cash">ğŸ’µ Cash / Ù†Ù‚Ø¯ÙŠ</span>',
          'card': '<span class="method-badge method-card">ğŸ’³ Card / Ø¨Ø·Ø§Ù‚Ø©</span>',
          'tamara': '<span class="method-badge method-tamara">ğŸ›ï¸ Tamara / ØªÙ…Ø§Ø±Ø§</span>',
          'tabby': '<span class="method-badge method-tabby">ğŸ›’ Tabby / ØªØ§Ø¨ÙŠ</span>'
        };
        return badges[method] || '';
      }

      const ones = ['', 'ÙˆØ§Ø­Ø¯', 'Ø§Ø«Ù†Ø§Ù†', 'Ø«Ù„Ø§Ø«Ø©', 'Ø£Ø±Ø¨Ø¹Ø©', 'Ø®Ù…Ø³Ø©', 'Ø³ØªØ©', 'Ø³Ø¨Ø¹Ø©', 'Ø«Ù…Ø§Ù†ÙŠØ©', 'ØªØ³Ø¹Ø©'];
      const tens = ['', '', 'Ø¹Ø´Ø±ÙˆÙ†', 'Ø«Ù„Ø§Ø«ÙˆÙ†', 'Ø£Ø±Ø¨Ø¹ÙˆÙ†', 'Ø®Ù…Ø³ÙˆÙ†', 'Ø³ØªÙˆÙ†', 'Ø³Ø¨Ø¹ÙˆÙ†', 'Ø«Ù…Ø§Ù†ÙˆÙ†', 'ØªØ³Ø¹ÙˆÙ†'];
      const teens = ['Ø¹Ø´Ø±Ø©', 'Ø£Ø­Ø¯ Ø¹Ø´Ø±', 'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±', 'Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±', 'Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø®Ù…Ø³Ø© Ø¹Ø´Ø±', 'Ø³ØªØ© Ø¹Ø´Ø±', 'Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±', 'ØªØ³Ø¹Ø© Ø¹Ø´Ø±'];
      const hundreds = ['', 'Ù…Ø§Ø¦Ø©', 'Ù…Ø§Ø¦ØªØ§Ù†', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©', 'Ø³ØªÙ…Ø§Ø¦Ø©', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©'];

      function numberToArabicWords(num) {
        if (num === 0) return 'ØµÙØ±';
        
        let result = '';
        
        if (num >= 1000) {
          const thousands = Math.floor(num / 1000);
          if (thousands === 1) result += 'Ø£Ù„Ù';
          else if (thousands === 2) result += 'Ø£Ù„ÙØ§Ù†';
          else if (thousands <= 10) result += ones[thousands] + ' Ø¢Ù„Ø§Ù';
          else result += convertHundreds(thousands) + ' Ø£Ù„Ù';
          num %= 1000;
          if (num > 0) result += ' Ùˆ';
        }
        
        result += convertHundreds(num);
        
        return result;
      }

      function convertHundreds(num) {
        let result = '';
        
        if (num >= 100) {
          result += hundreds[Math.floor(num / 100)];
          num %= 100;
          if (num > 0) result += ' Ùˆ';
        }
        
        if (num >= 20) {
          result += tens[Math.floor(num / 10)];
          num %= 10;
          if (num > 0) result += ' Ùˆ' + ones[num];
        } else if (num >= 10) {
          result += teens[num - 10];
        } else if (num > 0) {
          result += ones[num];
        }
        
        return result;
      }

      function amountToWords(amount) {
        const num = parseFloat(amount);
        const riyals = Math.floor(num);
        const halalas = Math.round((num - riyals) * 100);
        
        let text = numberToArabicWords(riyals) + ' Ø±ÙŠØ§Ù„';
        if (halalas > 0) {
          text += ' Ùˆ' + numberToArabicWords(halalas) + ' Ù‡Ù„Ù„Ø©';
        }
        text += ' Ø³Ø¹ÙˆØ¯ÙŠ ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±';
        
        return text;
      }

      function populateReceipt(){
        document.getElementById('receiptNo').textContent = String(receiptData.receiptNo||'-');
        document.getElementById('invoiceNo').textContent = String(receiptData.invoiceNo||'-');
        const amountValue = formatAmount(receiptData.amount);
        document.getElementById('amount').innerHTML = `[${amountValue}] <span class="currency-symbol">&#xE900;</span>`;
        document.getElementById('amountWords').textContent = amountToWords(receiptData.amount);
        document.getElementById('paymentMethod').textContent = getPaymentMethodName(receiptData.paymentMethod);
        document.getElementById('userName').textContent = receiptData.userName;
        document.getElementById('receiptDate').textContent = formatDate(receiptData.date);
        document.getElementById('receiptTime').textContent = formatTime(receiptData.date);
        document.getElementById('printDate').textContent = formatDate(new Date().toISOString()) + ' ' + formatTime(new Date().toISOString());
        const setRow = (id, val, target) => {
          const row = document.getElementById(id);
          const el = document.getElementById(target);
          if(val && String(val).trim() !== ''){ row.style.display='flex'; el.textContent = String(val); } else { row.style.display='none'; }
        };
        setRow('rowName', receiptData.customerName, 'customerName');
        setRow('rowAddress', receiptData.customerAddress, 'customerAddress');
        setRow('rowPhone', receiptData.customerPhone, 'customerPhone');
        setRow('rowEmail', receiptData.customerEmail, 'customerEmail');
        setRow('rowVat', receiptData.customerVat, 'customerVat');
        setRow('rowCR', receiptData.customerCR, 'customerCR');
        setRow('rowNat', receiptData.customerNational, 'customerNational');
        const rsn = receiptData.reason || (receiptData.invoiceNo ? ('Ø³Ù†Ø¯ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ' + receiptData.invoiceNo) : (receiptData.notes||''));
        document.getElementById('reason').textContent = rsn || '-';
      }

      document.getElementById('exportBtn').addEventListener('click', async () => {
        try {
          const btn = document.getElementById('exportBtn');
          btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
          btn.disabled = true;
          
          const root = document.documentElement.cloneNode(true);
          Array.from(root.querySelectorAll('script')).forEach(s=>s.remove());
          Array.from(root.querySelectorAll('.btn-container')).forEach(el=>el.remove());
          
          try{
            const img = root.querySelector('#logo');
            const settings = await window.api.settings_get();
            if(img && settings && settings.ok && settings.item && settings.item.logo_path){
              let absLogo = '';
              if(String(settings.item.logo_path).startsWith('assets/')){
                const rp = await window.api.resolve_path(settings.item.logo_path);
                if(rp && rp.ok){ 
                  absLogo = 'file:///' + String(rp.abs||'').replace(/\\/g,'/'); 
                }
              }else{
                absLogo = 'file:///' + String(settings.item.logo_path||'').replace(/\\/g,'/');
              }
              if(absLogo){ img.src = absLogo; }
            }
          }catch(_){ }
          
          const html = '<!doctype html>' + root.outerHTML;
          const fname = `Receipt_${receiptData.receiptNo}_Invoice_${receiptData.invoiceNo}.pdf`;
          const r = await window.opener?.api?.pdf_export(html, { 
            pageSize: 'A4', 
            printBackground: true, 
            saveMode: 'auto', 
            filename: fname 
          });
          
          if(!r || !r.ok){ 
            alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„Ø³Ù†Ø¯ Ø§Ù„Ù‚Ø¨Ø¶'); 
            btn.textContent = 'ØªØµØ¯ÙŠØ± PDF';
            btn.disabled = false;
            return;
          }
          
          btn.textContent = 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“';
          setTimeout(() => {
            btn.textContent = 'ØªØµØ¯ÙŠØ± PDF';
            btn.disabled = false;
          }, 2000);
        } catch (error) {
          console.error('Failed to export PDF:', error);
          alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF');
          const btn = document.getElementById('exportBtn');
          btn.textContent = 'ØªØµØ¯ÙŠØ± PDF';
          btn.disabled = false;
        }
      });

      async function maybeLoadCustomer(){
        try{
          if(receiptData.customerId){
            const r = await (api.customers_get ? api.customers_get(receiptData.customerId) : null);
            if(r && r.ok && r.item){
              const c = r.item;
              receiptData.customerName = receiptData.customerName || c.name || null;
              receiptData.customerPhone = receiptData.customerPhone || c.phone || null;
              receiptData.customerEmail = receiptData.customerEmail || c.email || null;
              receiptData.customerAddress = receiptData.customerAddress || c.address || null;
              receiptData.customerVat = receiptData.customerVat || c.vat_number || null;
              receiptData.customerCR = receiptData.customerCR || c.cr_number || null;
              receiptData.customerNational = receiptData.customerNational || c.national_address || null;
              if(!receiptData.reason && c.notes){ receiptData.reason = c.notes; }
            }
          }
        }catch(_){ }
      }

      (async function init(){
        await loadSettings();
        await maybeLoadCustomer();
        populateReceipt();
        
        if(params.get('auto_print') === '1'){
          setTimeout(() => window.print(), 500);
        }
      })();
    </script>
  </body>
</html>
