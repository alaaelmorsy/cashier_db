<!-- Unit Selection Modal - Ultra Professional, Fast & Beautiful -->
<style>
  /* ======== UNIT SELECTOR MODAL STYLES ======== */
  .unit-selector-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.12) 0%, transparent 50%),
      linear-gradient(135deg, rgba(15, 23, 42, 0.85) 0%, rgba(88, 28, 135, 0.75) 100%);
    z-index: 5000;
    backdrop-filter: blur(12px);
    animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateZ(0);
  }

  .unit-selector-overlay.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @keyframes fadeIn {
    from { 
      opacity: 0; 
      backdrop-filter: blur(0px); 
    }
    to { 
      opacity: 1; 
      backdrop-filter: blur(12px); 
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(40px) scale(0.92);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }

  .unit-selector-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px) saturate(180%);
    border-radius: 28px;
    box-shadow: 
      0 30px 90px rgba(0, 0, 0, 0.4),
      0 0 150px rgba(139, 92, 246, 0.25),
      inset 0 1px 0 rgba(255, 255, 255, 0.95),
      0 0 0 1px rgba(139, 92, 246, 0.2);
    width: min(580px, 96vw);
    max-height: 92vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s cubic-bezier(0.34, 1.45, 0.64, 1);
    will-change: transform, opacity;
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* ======== HEADER ======== */
  .unit-selector-header {
    padding: 22px 26px;
    background: linear-gradient(135deg, 
      #6366f1 0%, 
      #8b5cf6 35%, 
      #a855f7 70%, 
      #ec4899 100%
    );
    border-bottom: 3px solid rgba(236, 72, 153, 0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 14px;
    position: relative;
    overflow: hidden;
  }

  .unit-selector-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(255, 255, 255, 0.6), 
      transparent
    );
  }

  .unit-selector-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.15) 50%,
      transparent 100%
    );
    background-size: 200% 100%;
    animation: shimmer 3s ease-in-out infinite;
  }

  .unit-selector-header-title {
    color: #fff;
    font-size: 19px;
    font-weight: 900;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    position: relative;
    z-index: 1;
    text-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
  }

  .unit-selector-header-icon {
    font-size: 24px;
    line-height: 1;
    animation: float 2.5s ease-in-out infinite;
    filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
    50% { transform: translateY(-4px) scale(1.1) rotate(-5deg); }
  }

  .unit-selector-close {
    background: rgba(255, 255, 255, 0.2);
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    backdrop-filter: blur(10px);
  }

  .unit-selector-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg) scale(1.15);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.3),
      0 0 20px rgba(255, 255, 255, 0.4);
  }

  .unit-selector-close:active {
    transform: rotate(90deg) scale(0.95);
  }

  /* ======== PRODUCT INFO SECTION ======== */
  .unit-selector-product-info {
    padding: 22px 26px;
    background: 
      radial-gradient(circle at 100% 0%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
      linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    border-bottom: 1px solid rgba(168, 85, 247, 0.2);
    position: relative;
  }

  .product-info-row {
    display: flex;
    gap: 18px;
    align-items: flex-start;
  }

  .product-image-container {
    position: relative;
    width: 90px;
    height: 90px;
    border-radius: 18px;
    overflow: hidden;
    border: 3px solid #fff;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 
      0 10px 25px rgba(139, 92, 246, 0.2),
      0 0 0 1px rgba(168, 85, 247, 0.15);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .product-image-container:hover {
    transform: scale(1.08) rotate(3deg);
    box-shadow: 
      0 12px 30px rgba(139, 92, 246, 0.3),
      0 0 30px rgba(236, 72, 153, 0.2);
  }

  .product-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-image-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #ec4899 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 32px;
  }

  .product-text-info {
    flex: 1;
    min-width: 0;
  }

  .product-name {
    font-size: 17px;
    font-weight: 900;
    color: #0f172a;
    margin: 0 0 6px 0;
    word-break: break-word;
    line-height: 1.35;
    letter-spacing: 0.3px;
  }

  .product-category {
    font-size: 13px;
    color: #fff;
    font-weight: 800;
    margin: 3px 0;
    display: inline-block;
    background: linear-gradient(135deg, #8b5cf6, #a855f7);
    padding: 4px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
  }

  .product-sku {
    font-size: 11px;
    color: #64748b;
    margin: 8px 0 0 0;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  /* ======== UNITS GRID ======== */
  .unit-selector-body {
    padding: 26px;
    overflow-y: auto;
    flex: 1;
    background: 
      radial-gradient(circle at 0% 0%, rgba(168, 85, 247, 0.04) 0%, transparent 50%),
      radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.04) 0%, transparent 50%),
      linear-gradient(to bottom, #fafbfd 0%, #f5f3ff 100%);
  }

  .unit-selector-body::-webkit-scrollbar {
    width: 10px;
  }

  .unit-selector-body::-webkit-scrollbar-track {
    background: rgba(168, 85, 247, 0.05);
    border-radius: 5px;
  }

  .unit-selector-body::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #8b5cf6 0%, #a855f7 100%);
    border-radius: 5px;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .unit-selector-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #7c3aed 0%, #9333ea 100%);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
  }

  .units-label {
    font-size: 12px;
    font-weight: 800;
    color: #6b21a8;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .units-label::before {
    content: '‚óÜ';
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 16px;
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { 
      opacity: 1; 
      transform: scale(1) rotate(0deg); 
    }
    50% { 
      opacity: 0.6; 
      transform: scale(1.3) rotate(45deg); 
    }
  }

  .units-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 14px;
  }

  /* ======== UNIT CARD ======== */
  .unit-card {
    padding: 16px 14px;
    border: 2.5px solid rgba(168, 85, 247, 0.15);
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    will-change: transform;
    transform: translateZ(0);
  }

  .unit-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
      circle at 50% 0%, 
      rgba(139, 92, 246, 0.1) 0%, 
      rgba(236, 72, 153, 0.05) 100%
    );
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .unit-card::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, transparent 70%);
    opacity: 0;
    transform: scale(0);
    transition: transform 0.5s ease, opacity 0.5s ease;
  }

  .unit-card:hover {
    border-color: transparent;
    border-image: linear-gradient(135deg, 
      #8b5cf6, 
      #a855f7, 
      #ec4899,
      #f472b6,
      #a855f7,
      #8b5cf6
    ) 1;
    box-shadow: 
      0 10px 30px rgba(139, 92, 246, 0.25),
      0 0 40px rgba(236, 72, 153, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.6);
    transform: translateY(-4px) scale(1.03);
  }

  .unit-card:hover::before {
    opacity: 1;
  }

  .unit-card:active::after {
    opacity: 1;
    transform: scale(1);
    transition: transform 0s, opacity 0s;
  }

  .unit-card.selected {
    background: linear-gradient(135deg, 
      rgba(249, 240, 255, 0.95) 0%, 
      rgba(243, 232, 255, 0.95) 100%
    );
    backdrop-filter: blur(15px);
    border: 3px solid;
    border-image: linear-gradient(135deg, #8b5cf6, #a855f7, #ec4899) 1;
    box-shadow: 
      0 15px 40px rgba(139, 92, 246, 0.35),
      0 0 60px rgba(236, 72, 153, 0.25),
      0 0 0 4px rgba(168, 85, 247, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-3px);
  }

  .unit-card.selected::before {
    background: radial-gradient(
      circle at 50% 0%, 
      rgba(139, 92, 246, 0.15) 0%, 
      rgba(236, 72, 153, 0.1) 100%
    );
    opacity: 1;
  }

  .unit-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    gap: 8px;
  }

  .unit-card-name {
    font-size: 14px;
    font-weight: 800;
    color: #0f172a;
    flex: 1;
    min-width: 0;
    word-break: break-word;
    letter-spacing: 0.3px;
  }

  .unit-card.selected .unit-card-name {
    background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .unit-card-badge {
    display: none;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #a855f7, #ec4899);
    color: #fff;
    font-size: 15px;
    font-weight: 900;
    flex-shrink: 0;
    align-items: center;
    justify-content: center;
    box-shadow: 
      0 4px 15px rgba(139, 92, 246, 0.5),
      0 0 20px rgba(236, 72, 153, 0.3);
    animation: badge-appear 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), pulse-badge 2s ease-in-out infinite;
  }

  @keyframes badge-appear {
    0% { transform: scale(0) rotate(-180deg); opacity: 0; }
    100% { transform: scale(1) rotate(0); opacity: 1; }
  }

  @keyframes pulse-badge {
    0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5); }
    50% { transform: scale(1.1); box-shadow: 0 6px 20px rgba(236, 72, 153, 0.6); }
  }

  .unit-card.selected .unit-card-badge {
    display: flex;
  }

  .unit-card-price {
    font-size: 16px;
    font-weight: 900;
    color: #059669;
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    padding: 8px 12px;
    border-radius: 11px;
    text-align: center;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 10px rgba(5, 150, 105, 0.2);
    border: 1.5px solid rgba(5, 150, 105, 0.25);
  }

  .unit-card.selected .unit-card-price {
    background: linear-gradient(135deg, #fae8ff, #e9d5ff);
    color: #7c3aed;
    border-color: rgba(139, 92, 246, 0.4);
    box-shadow: 0 3px 12px rgba(139, 92, 246, 0.3);
  }

  .unit-card-stock {
    font-size: 11px;
    color: #64748b;
    margin-top: 8px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .unit-card-stock::before {
    content: '‚óè';
    color: #10b981;
    font-size: 14px;
    animation: blink-green 2s ease-in-out infinite;
  }

  @keyframes blink-green {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .unit-card-stock.low {
    color: #d97706;
  }

  .unit-card-stock.low::before {
    color: #f59e0b;
    animation: blink-orange 1.5s ease-in-out infinite;
  }

  @keyframes blink-orange {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .unit-card-stock.empty {
    color: #dc2626;
  }

  .unit-card-stock.empty::before {
    color: #ef4444;
    animation: blink-red 1s ease-in-out infinite;
  }

  @keyframes blink-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
  }

  /* ======== FOOTER ======== */
  .unit-selector-footer {
    padding: 18px 26px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-top: 2px solid;
    border-image: linear-gradient(90deg, 
      transparent, 
      rgba(168, 85, 247, 0.3), 
      rgba(236, 72, 153, 0.3), 
      transparent
    ) 1;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 -6px 20px rgba(139, 92, 246, 0.08);
  }

  .unit-selector-quantity {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #fff;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 8px 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .qty-btn {
    width: 32px;
    height: 32px;
    border: 0;
    border-radius: 10px;
    background: rgba(168, 85, 247, 0.1);
    color: #6b21a8;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 18px;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    flex-shrink: 0;
    border: 1.5px solid rgba(168, 85, 247, 0.2);
  }

  .qty-btn:hover {
    background: linear-gradient(135deg, #8b5cf6, #a855f7);
    color: #fff;
    transform: scale(1.15);
    box-shadow: 
      0 4px 15px rgba(139, 92, 246, 0.4),
      0 0 20px rgba(236, 72, 153, 0.2);
    border-color: transparent;
  }

  .qty-btn:active {
    transform: scale(0.95);
  }

  .qty-input {
    width: 52px;
    text-align: center;
    border: 0;
    background: transparent;
    font-size: 16px;
    font-weight: 900;
    color: #0f172a;
    padding: 4px 8px;
  }

  .qty-input:focus {
    outline: none;
  }

  .unit-selector-actions {
    display: flex;
    gap: 10px;
    flex: 1;
  }

  .btn-unit-cancel {
    flex: 1;
    padding: 12px 18px;
    border: 2px solid rgba(168, 85, 247, 0.2);
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 800;
    color: #6b21a8;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .btn-unit-cancel:hover {
    border-color: rgba(168, 85, 247, 0.4);
    background: rgba(250, 245, 255, 0.9);
    color: #7c3aed;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.15);
  }

  .btn-unit-cancel:active {
    transform: translateY(0);
  }

  .btn-unit-add {
    flex: 2;
    padding: 12px 18px;
    border: 0;
    background: linear-gradient(135deg, 
      #6366f1 0%, 
      #8b5cf6 35%, 
      #a855f7 70%, 
      #ec4899 100%
    );
    border-radius: 14px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 900;
    color: #fff;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 
      0 8px 25px rgba(139, 92, 246, 0.4),
      0 0 40px rgba(236, 72, 153, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
  }

  .btn-unit-add::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.3) 50%,
      transparent 100%
    );
    background-size: 200% 100%;
    animation: shimmer 2s ease-in-out infinite;
  }

  .btn-unit-add:hover {
    transform: translateY(-3px);
    box-shadow: 
      0 12px 35px rgba(139, 92, 246, 0.5),
      0 0 60px rgba(236, 72, 153, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  .btn-unit-add:active {
    transform: translateY(-1px);
    box-shadow: 
      0 6px 20px rgba(139, 92, 246, 0.4),
      0 0 30px rgba(236, 72, 153, 0.2);
  }

  .btn-unit-add:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.6;
  }

  .btn-unit-add:disabled::before {
    display: none;
  }

  /* ======== EMPTY STATE ======== */
  .unit-selector-empty {
    text-align: center;
    padding: 50px 20px;
    color: #64748b;
  }

  .unit-selector-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    animation: float 2.5s ease-in-out infinite;
  }

  .unit-selector-empty-text {
    font-size: 15px;
    font-weight: 700;
    margin: 0;
    color: #475569;
  }

  /* ======== RESPONSIVE ======== */
  @media (max-width: 520px) {
    .unit-selector-content {
      width: 98vw;
      max-height: 88vh;
      border-radius: 20px;
    }

    .units-grid {
      grid-template-columns: 1fr;
    }

    .product-info-row {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .product-image-container {
      width: 100px;
      height: 100px;
    }

    .unit-selector-footer {
      flex-direction: column;
      gap: 10px;
    }

    .unit-selector-quantity {
      width: 100%;
      justify-content: center;
    }

    .unit-selector-actions {
      width: 100%;
    }

    .btn-unit-cancel,
    .btn-unit-add {
      flex: 1;
    }
  }

  /* ======== KEYBOARD NAVIGATION ======== */
  .unit-card:focus-visible {
    outline: 3px solid #8b5cf6;
    outline-offset: 3px;
    box-shadow: 
      0 0 0 6px rgba(139, 92, 246, 0.2),
      0 10px 30px rgba(139, 92, 246, 0.3);
  }

  /* ======== PERFORMANCE OPTIMIZATIONS ======== */
  .unit-card,
  .qty-btn,
  .btn-unit-add,
  .btn-unit-cancel,
  .unit-selector-close,
  .product-image-container {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
</style>

<!-- Modal HTML -->
<div id="unitSelectorOverlay" class="unit-selector-overlay">
  <div class="unit-selector-content">
    <!-- Header -->
    <div class="unit-selector-header">
      <h2 class="unit-selector-header-title">
        <span class="unit-selector-header-icon">üì¶</span>
        ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©
      </h2>
      <button class="unit-selector-close" onclick="unitSelector.close()" title="ÿ•ÿ∫ŸÑÿßŸÇ">‚úï</button>
    </div>

    <!-- Product Info -->
    <div class="unit-selector-product-info">
      <div class="product-info-row">
        <div class="product-image-container">
          <img id="unitSelectorProductImage" src="" alt="ÿßŸÑŸÖŸÜÿ™ÿ¨" onerror="this.parentElement.innerHTML='<div class=&quot;product-image-placeholder&quot;></div>'">
        </div>
        <div class="product-text-info">
          <p class="product-name" id="unitSelectorProductName">-</p>
          <p class="product-category" id="unitSelectorProductCategory">-</p>
          <p class="product-sku" id="unitSelectorProductSKU">-</p>
        </div>
      </div>
    </div>

    <!-- Body: Units Grid -->
    <div class="unit-selector-body">
      <span class="units-label">ÿßŸÑŸàÿ≠ÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</span>
      <div id="unitSelectorGrid" class="units-grid">
        <!-- Units will be rendered here -->
      </div>
      <div id="unitSelectorEmpty" class="unit-selector-empty" style="display: none;">
        <div class="unit-selector-empty-icon">üì≠</div>
        <p class="unit-selector-empty-text">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="unit-selector-footer">
      <div class="unit-selector-quantity">
        <button class="qty-btn" onclick="unitSelector.decreaseQty()" title="ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©">‚àí</button>
        <input type="number" class="qty-input" id="unitSelectorQty" value="1" min="1" onchange="unitSelector.updateQty()" onkeydown="if(event.key==='Enter') unitSelector.add()">
        <button class="qty-btn" onclick="unitSelector.increaseQty()" title="ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÉŸÖŸäÿ©">+</button>
      </div>
      <div class="unit-selector-actions">
        <button class="btn-unit-cancel" onclick="unitSelector.close()">ÿ•ŸÑÿ∫ÿßÿ°</button>
        <button class="btn-unit-add" id="unitSelectorAddBtn" onclick="unitSelector.add()">ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ© ‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- Unit Selector Logic -->
<script>
const unitSelector = {
  product: null,
  units: [],
  selectedUnitId: null,
  callback: null,

  async open(productId, productName, productCategory, productImage, onSelect) {
    try {
      this.product = { id: productId, name: productName, category: productCategory, image: productImage };
      this.callback = onSelect;
      this.selectedUnitId = null;
      
      // Load units/operations for this product
      const result = await window.api.prod_ops_list(productId);
      
      if (!result.ok || !result.items) {
        this.units = [];
      } else {
        this.units = result.items || [];
      }

      // If no operations exist, create a default one
      if (this.units.length === 0) {
        this.units = [{ operation_id: 0, name: 'ÿßŸÑŸàÿ≠ÿØÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©', price: 0, is_active: 1 }];
      }

      // Reset quantity
      document.getElementById('unitSelectorQty').value = '1';

      // Update UI
      this.render();
      
      // Show overlay with smooth animation
      const overlay = document.getElementById('unitSelectorOverlay');
      if (overlay) {
        overlay.classList.add('show');
        // Focus on first unit or quantity input
        setTimeout(() => {
          const firstCard = document.querySelector('.unit-card');
          if (firstCard) {
            firstCard.setAttribute('tabindex', '0');
          }
          document.getElementById('unitSelectorQty')?.focus();
        }, 150);
      }
    } catch (err) {
      console.error('Failed to open unit selector:', err);
      alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™');
    }
  },

  render() {
    // Update product info
    const img = document.getElementById('unitSelectorProductImage');
    if (img) {
      img.src = this.product.image || '../../../assets/icon/app.png';
      img.onerror = function() {
        this.style.display = 'none';
        this.parentElement.innerHTML = '<div class="product-image-placeholder">üì∑</div>';
      };
    }
    
    document.getElementById('unitSelectorProductName').textContent = this.product.name || '-';
    document.getElementById('unitSelectorProductCategory').textContent = this.product.category || '-';
    document.getElementById('unitSelectorProductSKU').textContent = `ŸÖÿπÿ±ŸÅ: ${this.product.id}`;

    // Render units grid
    const grid = document.getElementById('unitSelectorGrid');
    const empty = document.getElementById('unitSelectorEmpty');

    if (this.units.length === 0) {
      grid.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';
    grid.innerHTML = this.units.map((unit, idx) => {
      const isSelected = this.selectedUnitId === (unit.operation_id || idx);
      const priceText = unit.price && Number(unit.price) > 0 
        ? `${Number(unit.price).toFixed(2)} ÿ±.ÿ≥`
        : 'ÿ®ÿØŸàŸÜ ÿ≥ÿπÿ±';
      
      return `
        <div class="unit-card ${isSelected ? 'selected' : ''}" onclick="unitSelector.selectUnit(${unit.operation_id || idx})" tabindex="0" role="button" aria-pressed="${isSelected}" onkeydown="if(event.key==='Enter'||event.key===' ') unitSelector.selectUnit(${unit.operation_id || idx})">
          <div class="unit-card-header">
            <span class="unit-card-name">${unit.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}</span>
            ${isSelected ? '<div class="unit-card-badge">‚úì</div>' : ''}
          </div>
          <div class="unit-card-price">${priceText}</div>
          <div class="unit-card-stock">ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ∑ŸÑÿ®</div>
        </div>
      `;
    }).join('');

    // Select first unit by default
    if (this.selectedUnitId === null && this.units.length > 0) {
      this.selectedUnitId = this.units[0].operation_id || 0;
      this.render();
    }

    // Update add button state
    this.updateAddButton();
  },

  selectUnit(unitId) {
    this.selectedUnitId = unitId;
    this.render();
  },

  increaseQty() {
    const input = document.getElementById('unitSelectorQty');
    input.value = Math.max(1, Number(input.value) + 1);
  },

  decreaseQty() {
    const input = document.getElementById('unitSelectorQty');
    input.value = Math.max(1, Number(input.value) - 1);
  },

  updateQty() {
    const input = document.getElementById('unitSelectorQty');
    input.value = Math.max(1, Number(input.value) || 1);
  },

  updateAddButton() {
    const btn = document.getElementById('unitSelectorAddBtn');
    if (btn) {
      btn.disabled = this.selectedUnitId === null;
    }
  },

  add() {
    if (this.selectedUnitId === null) {
      alert('ÿßÿÆÿ™ÿ± Ÿàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã');
      return;
    }

    const qty = Number(document.getElementById('unitSelectorQty').value) || 1;
    const selectedUnit = this.units.find(u => (u.operation_id || 0) === this.selectedUnitId);

    if (!selectedUnit) {
      alert('ÿßŸÑŸàÿ≠ÿØÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
      return;
    }

    if (this.callback) {
      this.callback({
        operation_id: selectedUnit.operation_id,
        operation_name: selectedUnit.name,
        price: Number(selectedUnit.price || 0),
        qty: qty
      });
    }

    this.close();
  },

  close() {
    const overlay = document.getElementById('unitSelectorOverlay');
    if (overlay) {
      overlay.classList.remove('show');
    }
    // Small delay before resetting to allow animation to complete
    setTimeout(() => {
      this.product = null;
      this.units = [];
      this.selectedUnitId = null;
    }, 200);
  }
};

// Close on overlay click
document.getElementById('unitSelectorOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'unitSelectorOverlay') {
    unitSelector.close();
  }
});

// Close on Escape key
document.addEventListener('keydown', (e) => {
  const overlay = document.getElementById('unitSelectorOverlay');
  if (e.key === 'Escape' && overlay?.classList.contains('show')) {
    unitSelector.close();
  }
});

// Keyboard navigation for units
document.addEventListener('keydown', (e) => {
  const overlay = document.getElementById('unitSelectorOverlay');
  if (!overlay?.classList.contains('show')) return;

  const cards = Array.from(document.querySelectorAll('.unit-card'));
  if (cards.length === 0) return;

  const currentIndex = cards.findIndex(card => card.classList.contains('selected'));

  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
    e.preventDefault();
    const nextIndex = (currentIndex + 1) % cards.length;
    const nextCard = cards[nextIndex];
    if (nextCard) {
      nextCard.click();
      nextCard.focus();
    }
  } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
    e.preventDefault();
    const prevIndex = currentIndex <= 0 ? cards.length - 1 : currentIndex - 1;
    const prevCard = cards[prevIndex];
    if (prevCard) {
      prevCard.click();
      prevCard.focus();
    }
  }
});
</script>