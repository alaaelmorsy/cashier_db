<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÙØ§ØªÙˆØ±Ø© A4</title>
    <style>
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-Black.ttf') format('truetype');
        font-weight: 900;
        font-display: swap;
      }
      @font-face{
        font-family: 'saudi_riyal';
        src: url('../../../assets/fonts/saudi-riyal.woff') format('woff'),
             url('../../../assets/fonts/saudi-riyal.ttf') format('truetype');
        font-display: swap;
        unicode-range: U+E900; /* Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø®Ø§Øµ 'î¤€' */
      }
      /* Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ù… Ù„ØªÙØ§Ø¯ÙŠ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…Ø­Ø§Ø±Ù Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
      body{ font-family: 'Cairo', 'saudi_riyal', system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Arial, sans-serif; margin:0; color:#000; font-weight:900; font-size:12px; letter-spacing:.1px; }
      :root{ --m-left: 0mm; --m-right: 0mm; }
      .page{ width: 190mm; min-height: 297mm; margin: 0 auto; padding: 0; box-sizing:border-box; }
      .header{ display:flex; flex-direction:column; gap:4px; border-bottom:2px solid #cbd5e1; padding-bottom:6px; }
      .headerTop{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px; }
      .company-box.ar{ text-align:right; direction:rtl; }
      .company-box.en{ text-align:left; direction:ltr; }
      .brand-center img{ width:60px; height:60px; border-radius:8px; object-fit:contain; border:1px solid #cbd5e1; background:#fff; }
      .brand{ display:flex; gap:8px; align-items:center; }
      .brand img{ width:55px; height:55px; border-radius:8px; object-fit:contain; border:1px solid #cbd5e1; background:#fff; }
      .brand h1{ margin:0; font-size:18px; font-weight:800; }
      .company-box h1{ margin:0; font-size:18px; font-weight:800; }
      #invType{ font-size:18px; font-weight:800; }
      .muted{ color:#000; font-weight:900; font-size: 13px; }
      .company-box .muted{ white-space: pre-wrap; font-size: 13px !important; }
      .desc-print{ color:#000; font-size:12px; font-weight:900; margin-top:4px; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; }
      .item-name-en{ font-size:11px; color:#000; font-weight:900; direction:ltr; text-align:left; margin-top:2px; }
      .item-barcode{ font-size:10.5px; color:#000; font-weight:900; direction:ltr; text-align:left; margin-top:2px; }
      .barcode-cell{ font-size:10.5px; color:#000; font-weight:900; direction:ltr; text-align:left; }
      /* ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ø­Ø¯ ÙŠØ¬Ù…Ø¹ Ø§Ù„Ø¨Ù†Ø¯ ÙˆÙˆØµÙÙ‡ */
      .item-row td, .item-desc-row td{ border-bottom:0 !important; }
      .item-row td{ border-top:2px solid #334155; }
      .item-desc-row td{ border-bottom:2px solid #334155; }
      .item-row td:first-child, .item-desc-row td:first-child{ border-right:2px solid #334155; }
      .item-row td:last-child, .item-desc-row td:last-child{ border-left:2px solid #334155; }

      .meta{ display:grid; gap:1px; font-size:12px; font-weight:900; }
      /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø·Ø§Ø± Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ ØªØ­Øª "Ù…Ø¯Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" (Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚) */
      #driverDetails{ border:0 !important; border-radius:0 !important; padding:0 !important; }
      .section-title{ margin:4px 0 3px; padding:4px 8px; background:#e5e7eb; border:1px solid #cbd5e1; border-radius:4px; font-weight:800; color:#0f172a; font-size:12px; }
      .section-badge{ display:inline-block; margin:0; padding:2px 5px; background:#e5e7eb; border:1px solid #cbd5e1; border-radius:3px; font-weight:800; color:#0f172a; font-size:10px; }
      h2{ margin:6px 0 4px; font-weight:800; }
      table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
      th, td{ padding:4px 6px; border-bottom:1px solid #cbd5e1; font-size:11px; font-weight:900; word-wrap:break-word; overflow-wrap:anywhere; }
      th{ background:#eef2ff; color:#0b3daa; text-align:right; }

      /* ØªØ±ÙˆÙŠØ³Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù…Ø³ØªØ·ÙŠÙ„ Ø³Ù…ÙŠÙƒ Ù…Ù…ÙŠØ² */
      #itemsTable thead{
        display: table-header-group;
      }
      #itemsTable thead tr{
        background: #f8fafc;
        border: 0;
      }
      #itemsTable thead th{
        border-bottom: 2px solid #0f172a !important; /* Ø®Ø· Ø³ÙÙ„ÙŠ Ù…Ø³ØªÙ…Ø± */
        border-left: 2px solid #0f172a;
        color: #000 !important;
        font-weight: 900 !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: anywhere !important;
        padding: 4px 6px !important;
        vertical-align: middle !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
        min-height: 30px;
      }
      #itemsTable thead th:first-child{ border-right: 2px solid #0f172a; }
      #itemsTable thead th:last-child{ border-left: 2px solid #0f172a; }
      /* Ø¥Ø·Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ Ø­ÙˆÙ„ ØµÙ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
      #itemsTable thead tr th:first-child{ border-right-width: 2px; }
      #itemsTable thead tr th:last-child{ border-left-width: 2px; }

      /* Ø¥Ø·Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ØµÙÙˆÙ */
      #itemsTable{ border: 3px solid #0f172a; border-radius: 8px; overflow: visible; table-layout: fixed; }
      #itemsTable.hide-barcode thead th:nth-child(1),
      #itemsTable.hide-barcode tbody td:nth-child(1){ display:none; }
      /* ÙÙˆØ§ØµÙ„ Ø¹Ù…ÙˆØ¯ÙŠØ© Ø«Ù‚ÙŠÙ„Ø© Ø¨ÙŠÙ† Ø®Ø§Ù†Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„ØªØ­Ù‚ÙŠÙ‚ ØªÙ†Ø§Ø³Ù‚ Ø¨ØµØ±ÙŠ */
      #itemsTable tbody td{ 
        border-left: 2px solid #0f172a; 
        vertical-align: middle; 
        overflow-wrap: anywhere; 
        word-break: break-word; 
        white-space: normal;
        min-height: 25px;
        height: auto;
        line-height: 1.3;
      }
      #itemsTable tbody td:first-child{ border-right: 2px solid #0f172a; }
      #itemsTable tbody tr{ border-bottom: 2px solid #0f172a; height: auto; }

      /* Ø¶Ø¨Ø· Ø£Ø¹Ù…Ø¯Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯: Ø¯Ø¹Ù… Ø£Ø¹Ù…Ø¯Ø© ØªÙØµÙŠÙ„ÙŠØ© (Ø¹Ø¯Ø¯/Ø³Ø¹Ø±/ØµØ§ÙÙŠ/Ù†Ø³Ø¨Ø©/Ø¶Ø±ÙŠØ¨Ø©/Ø¥Ø¬Ù…Ø§Ù„ÙŠ) + Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠ */
      /* Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */
      .has-op thead th:nth-child(1), .has-op tbody td:nth-child(1){ /* Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */ width:12%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(2), .has-op tbody td:nth-child(2){ /* Ø§Ù„ØµÙ†Ù */ width:20%; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(3), .has-op tbody td:nth-child(3){ /* Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */ width:8%; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; text-align:center; }
      .has-op thead th:nth-child(4), .has-op tbody td:nth-child(4){ /* Ø§Ù„Ø¹Ø¯Ø¯ */ width:7%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(5), .has-op tbody td:nth-child(5){ /* Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© */ width:9%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(6), .has-op tbody td:nth-child(6){ /* Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:11%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(7), .has-op tbody td:nth-child(7){ /* Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:7%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(8), .has-op tbody td:nth-child(8){ /* Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:10%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .has-op thead th:nth-child(9), .has-op tbody td:nth-child(9){ /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */ width:16%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }

      /* Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù…ÙˆØ¯ ØªÙ…Ø§Ù…Ù‹Ø§) */
      .no-op thead th:nth-child(1), .no-op tbody td:nth-child(1){ /* Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */ width:13%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(2), .no-op tbody td:nth-child(2){ /* Ø§Ù„ØµÙ†Ù */ width:22%; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(3), .no-op tbody td:nth-child(3){ /* Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */ display:none; }
      .no-op thead th:nth-child(4), .no-op tbody td:nth-child(4){ /* Ø§Ù„Ø¹Ø¯Ø¯ */ width:8%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(5), .no-op tbody td:nth-child(5){ /* Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© */ width:10%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(6), .no-op tbody td:nth-child(6){ /* Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:12%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(7), .no-op tbody td:nth-child(7){ /* Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:8%; text-align:center; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(8), .no-op tbody td:nth-child(8){ /* Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */ width:11%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }
      .no-op thead th:nth-child(9), .no-op tbody td:nth-child(9){ /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */ width:16%; text-align:left; white-space:normal; word-break:break-word; overflow-wrap:anywhere; padding:4px 6px; }

      /* Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¶Ø±ÙŠØ¨Ø©: Ø³Ù†Ø³ØªØ®Ø¯Ù… ØªØ®Ø·ÙŠØ· 4 Ø£Ø¹Ù…Ø¯Ø© Ù…Ø®ØµÙ‘Øµ Ø¹Ø¨Ø± Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ¬Ø³Ù… Ø§Ù„ØµÙÙˆÙ ÙÙŠ JSØŒ Ù„Ø°Ù„Ùƒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø¥Ø®ÙØ§Ø¡ Ø£Ø¹Ù…Ø¯Ø© 6 Ùˆ7 ÙÙ‚Ø· */
      /* Ø¥Ø¨Ù‚Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ ÙˆÙ„ÙƒÙ† Ø³ÙŠØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡Ø§ Ù…Ù† JS Ø¹Ù†Ø¯ 0% Ø¶Ø±ÙŠØ¨Ø© */
      table.no-vat thead th:nth-child(7), table.no-vat tbody td:nth-child(7),
      table.no-vat thead th:nth-child(8), table.no-vat tbody td:nth-child(8){ display:none; }
      /* Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: Ø­Ø¬Ù… Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ù‹Ø§ ÙˆØ®Ø· Ø«Ù‚ÙŠÙ„ Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ù…ØªØ³Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ */
      #itemsTable tbody td.num{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: clip;
        direction: ltr;
        unicode-bidi: plaintext;
        font-variant-numeric: tabular-nums;
        font-weight: 900;
        font-size: 10.5px;
        line-height: 1.2;
        letter-spacing: 0;
        word-break: keep-all;
        overflow-wrap: normal;
      }
      .totals{ margin-top:6px; width:320px; margin-left:auto; border:2px solid #334155; border-radius:6px; overflow:hidden; }
      .totals td{ padding:4px 8px; font-weight:900; font-size:14px; white-space:nowrap; }
      .totals tbody tr td:first-child{ border-left: 1px solid #cbd5e1; }
      .totals tbody tr{ border-bottom: 1px dashed #cbd5e1; }
      .totals tbody tr:last-child{ border-bottom: 0; }
      /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© */
      .totals tbody tr#extraRow td,
      .totals tbody tr#discRow td,
      .totals tbody tr#afterDiscRow td,
      .totals tbody tr#tobaccoFeeRow td,
      .totals tbody tr#paidCashRow td,
      .totals tbody tr#paidCardRow td,
      .totals tbody tr#paidRow td,
      .totals tbody tr#changeRow td{
        border-left: 2px solid #334155 !important;
        border-right: 2px solid #334155 !important;
      }
      /* Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ø§Ù„Ø£ÙˆØ³Ø· ÙÙŠ ØµÙÙˆÙ Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ */
      .totals tbody tr#paidRow td,
      .totals tbody tr#changeRow td{ border-left: 0 !important; }
      .totals tbody tr#paidRow td:first-child,
      .totals tbody tr#changeRow td:first-child{ border-left: 1px solid #cbd5e1 !important; }
      .totals tbody tr#paidRow td:last-child,
      .totals tbody tr#changeRow td:last-child{ border-left: 2px solid #334155 !important; }
      /* Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©ØŒ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©ØŒ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© */
      .totals tbody tr:has(td#sub) td,
      .totals tbody tr:has(td#vat) td,
      .totals tbody tr:has(td#grand) td{ background:#eef2ff; }
      /* Ø­Ø¯ÙˆØ¯ Ø¨Ø¯Ø§ÙŠØ©/ÙÙˆØ§ØµÙ„/Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© */
      .totals tbody tr:has(td#sub) td{ border-top: 2px solid #334155 !important; }
      .totals tbody tr:has(td#vat) td{ border-top: 2px solid #334155 !important; }
      .totals tbody tr:has(td#grand) td{ border-top: 2px solid #334155 !important; }
      /* ÙØ§ØµÙ„ Ø³Ù…ÙŠÙƒ Ù„ØµÙ Ø§Ù„Ø®ØµÙ… ÙˆÙ…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø¨Ù‚ÙŠØ© ØµÙÙˆÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª */
      .totals tbody tr#discRow td,
      .totals tbody tr#afterDiscRow td{ border-top: 2px solid #334155 !important; }
      .totals tbody tr:last-child td{ border-bottom: 2px solid #334155 !important; }
      .footer{ margin-top:6px; display:flex; justify-content:space-between; align-items:center; }
      .bottom-summary{ margin-top:6px; display:flex; gap:12px; align-items:flex-start; justify-content:flex-start; flex-wrap:wrap; }
      .bottom-summary .totals-and-notes{ flex:1; min-width:320px; }
      .qr{ width:100px; height:100px; background:#fff; border:1px solid #cbd5e1; display:flex; align-items:center; justify-content:center; margin:6px; }
      .sign{ text-align:center; }
      #companyInfoAr, #companyInfoEn{ white-space:pre-wrap; font-size: 13px !important; }
      .currency-symbol{ font-family:'Cairo', 'saudi_riyal', system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Arial, sans-serif; font-size:1.35em; line-height:0; vertical-align:-0.05em; margin:0 2px; }
      .desc-title{ font-weight:800; color:#0b3daa; margin-inline-start:6px; }
      tr.item-desc-row td{ border-bottom:2.5px solid #64748b; }
      /* ØªØ®Ø·ÙŠØ· Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø´Ø¨ÙƒØ© Ø¹Ù…ÙˆØ¯ÙŠÙ† Ù…Ø¹ ÙØ§ØµÙ„ ÙˆØ³Ø·ÙŠ Ø«Ù‚ÙŠÙ„ ÙˆÙÙˆØ§ØµÙ„ Ø³Ù…ÙŠÙƒØ© Ø¨ÙŠÙ† Ø§Ù„Ø®Ø§Ù†Ø§Øª - Ø£Ø³ÙˆØ¯ ÙˆØ®Ø·ÙˆØ· Ø«Ù‚ÙŠÙ„Ø© */
      #custBox{ 
        display:grid !important; 
        grid-template-columns: 1fr 1fr; 
        gap:0; 
        position:relative; 
        border:3px solid #000 !important; /* ÙŠØªØºÙ„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø¶Ù…Ù‘Ù† */
        border-radius:8px; 
        overflow:hidden; 
        color:#000 !important; 
        font-weight:900; 
      }
      #custBox::before{ content:''; position:absolute; top:0; bottom:0; left:50%; width:3px; background:#000; }
      #custBox .cust-row{ padding:4px 8px; white-space:normal; word-break:break-word; color:#000 !important; font-weight:900; }
      #custBox .cust-row + .cust-row{ border-top: 2px solid #000 !important; }
      #a4cName{ grid-column: auto; background:transparent; font-weight:900; border-bottom:0; color:#000 !important; }
      /* Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø®Ø· Ø£Ø³ÙˆØ¯ ÙˆØ­Ø¯ÙˆØ¯ Ø«Ù‚ÙŠÙ„Ø© */
      #customerTitle{ background:#e5e7eb !important; border:2px solid #000 !important; color:#000 !important; font-weight:900 !important; }

      /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†Ù‚Ø³Ù…: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙŠÙ…ÙŠÙ†ØŒ ÙØ§ØªÙˆØ±Ø© ÙŠØ³Ø§Ø± */
      .notes-box{ display:grid; grid-template-columns: 1fr 1fr; gap:0; border:3px solid #000; border-radius:8px; overflow:hidden; position:relative; }
      .notes-box::before{ content:""; position:absolute; top:0; bottom:0; right:50%; width:3px; background:#000; transform:translateX(1.5px); }
      /* ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· */
      .notes-box.single{ grid-template-columns: 1fr; }
      .notes-box.single::before{ display:none; }
      .note-col{ padding:4px 8px; }
      .note-col + .note-col{ border-right:3px solid #000; }
      .note-title{ font-weight:900; margin-bottom:3px; }
      .note-text{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; }
      
      @media print {
        @page { size: A4; margin: 6mm 8mm 5mm 8mm; }
        
        html, body { height: auto !important; }
        body{ padding-left: 0; padding-right: 0; }
        /* Ensure content height doesn't exceed printable area to avoid blank trailing page */
        .page{ min-height: auto !important; height: auto !important; width: calc(210mm - 8mm - 8mm) !important; margin: 0 auto; }
        /* Avoid breaking key blocks across pages */
        .header, .totals, .footer, #custBox, #itemsTable thead { break-inside: avoid; page-break-inside: avoid; }
        #itemsTable tr.item-row, #itemsTable tr.item-desc-row { break-inside: avoid; page-break-inside: avoid; }
        /* Allow notes to break across pages if needed */
        .notes-box { break-inside: auto; page-break-inside: auto; }
        
        .header{ position:relative; z-index:1; background:#fff; }
      }
      .reprint-btn{ position:fixed; top:12px; left:12px; padding:8px 12px; border:0; border-radius:8px; background:#0b3daa; color:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.15); z-index:2147483647;}
      .export-btn{ position:fixed; top:52px; left:12px; padding:8px 12px; border:0; border-radius:8px; background:#16a34a; color:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.15); z-index:2147483647;}
      .whats-btn{ position:fixed; top:92px; left:12px; padding:8px 12px; border:0; border-radius:8px; background:#25D366; color:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.15); z-index:2147483647;}

      /* ØªØ·Ø¨ÙŠÙ‚ Ø®Ø· Ø£Ø³ÙˆØ¯ Ø«Ù‚ÙŠÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
      body{ color:#000 !important; font-weight:900 !important; }
      .muted, .section-title, .section-badge, h1, h2, th, td, #companyInfoAr, #companyInfoEn, .desc-print, #invType, .brand h1, .company-box h1, .totals td{
        color:#000 !important; font-weight:900 !important;
      }
      @media print { .reprint-btn, .export-btn, .whats-btn{ display:none } #lowStockBanner{ display:none !important; } }
    </style>
  </head>
  <body>
    <button class="reprint-btn" id="reprintBtn" onclick="window.print()">Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="export-btn" id="exportBtn">ØªØµØ¯ÙŠØ± PDF</button>
    <button class="whats-btn" id="whatsBtn">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
    
    <div class="page">
      <div class="header">
        <div class="headerTop">
          <div class="company-box ar">
            <h1 id="companyAr">Ø§Ù„Ø´Ø±ÙƒØ©</h1>
            <div class="muted" id="companyInfoAr"></div>
          </div>
          <div class="brand-center">
            <img id="logo" alt="" />
          </div>
          <div class="company-box en">
            <h1 id="companyEn">Company</h1>
            <div class="muted" id="companyInfoEn"></div>
          </div>
        </div>
        <div class="meta">
          <div style="display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px;">
            <div style="text-align:right;">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <b id="invNo"></b></div>
            <div style="text-align:center;"><span id="invType" class="section-badge" style="display:none;">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</span></div>
            <div style="text-align:left;">Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="invDate"></span></div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:12px;">
            <div>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <span id="invPay"></span></div>
          </div>
          <div id="userLineA4" style="display:none; justify-content:space-between; gap:12px; border:0 !important; padding:0 !important;">
            <div>Ù…Ø¯Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <span id="cashierNameA4"></span></div>
            <div></div>
          </div>
          <div id="paidAtLine" style="margin-top:4px; display:none; font-weight:700; color:#16a34a; background:#f0fdf4; padding:6px; border-radius:4px; border:1px solid #86efac;">ğŸ’³ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹: <span id="paidAt"></span></div>
          <div id="roomLine" class="muted" style="margin-top:4px;" hidden>Ø§Ù„ØºØ±ÙØ©: <span id="roomName"></span></div>
          <div id="driverTitle" class="section-title" style="display:none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
          <div id="driverDetails" class="muted" style="display:none; border:1px dashed #94a3b8; border-radius:8px; padding:8px;">
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div><span style="color:#334155">Ø§Ù„Ø§Ø³Ù…:</span> <span id="drvA4Name"></span></div>
              <div><span style="color:#334155">Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚:</span> <span id="drvA4Phone"></span></div>
            </div>
          </div>
          <div id="customerTitle" class="section-title" style="display:none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div id="custBox" class="muted" style="display:none; border:2.5px solid #334155; border-radius:8px; overflow:hidden; margin-top:4px;">
            <div class="cust-row" id="a4cName"></div>
            <div class="cust-row" id="a4cPhone" style="display:none;">Ø¬ÙˆØ§Ù„: <span></span></div>
            <div class="cust-row" id="a4cEmail" style="display:none;">Ø¥ÙŠÙ…ÙŠÙ„: <span></span></div>
            <div class="cust-row" id="a4cAddress" style="display:none;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span></span></div>
            <div class="cust-row" id="a4cVat" style="display:none;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: <span></span></div>
            <div class="cust-row" id="a4cCR" style="display:none;">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ: <span></span></div>
            <div class="cust-row" id="a4cNat" style="display:none;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ: <span></span></div>
            <div class="cust-row" id="a4cPostal" style="display:none;">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: <span></span></div>
            <div class="cust-row" id="a4cStreet" style="display:none;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰: <span></span></div>
            <div class="cust-row" id="a4cSub" style="display:none;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙØ±Ø¹ÙŠ: <span></span></div>
            <div class="cust-row" id="a4cNotes" style="display:none;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <span></span></div>
          </div>
          
          <div id="invoiceNotesContainer" style="display:none; margin-top:6px; border:2px solid #000; border-radius:6px; padding:4px 6px; width:100%; box-sizing:border-box;">
            <div style="font-weight:900; margin-bottom:2px; color:#000; font-size:10px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
            <div id="invoiceNotesContent" style="white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; color:#000; font-weight:700; font-size:9px; line-height:1.2;"></div>
          </div>
        </div>
      </div>

      <table id="itemsTable">
        <thead>
          <tr>
            <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
            <th>Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            <th id="thQuantity">Ø¹Ø¯Ø¯</th>
            <th id="thUnitPrice">Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
          </tr>
        </thead>
        <tbody id="items"></tbody>
      </table>

      <div class="bottom-summary">
        <div class="totals-and-notes">
          <table class="totals">
            <tbody>
              <tr id="extraRow" style="display:none"><td>Ø§Ù„Ø¥Ø¶Ø§ÙÙ‰</td><td style="text-align:left" id="extra"></td></tr>
              <tr><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td><td style="text-align:left" id="sub"></td></tr>
              <tr id="discRow" style="display:none"><td id="discLabel">Ø®ØµÙ…</td><td style="text-align:left; color:#b91c1c" id="disc"></td></tr>
              <tr id="afterDiscRow" style="display:none"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</td><td style="text-align:left" id="afterDisc"></td></tr>
              <tr id="tobaccoFeeRow" style="display:none"><td>Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ¨Øº</td><td style="text-align:left" id="tobaccoFee"></td></tr>
              <tr><td>Ø¶Ø±ÙŠØ¨Ø© VAT</td><td style="text-align:left" id="vat"></td></tr>
              <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</b></td><td style="text-align:left" id="grand"></td></tr>
              <!-- ØµÙÙˆÙ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© -->
              <tr id="paidCashRow" style="display:none"><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ø´</td><td style="text-align:left" id="paidCash"></td></tr>
              <tr id="paidCardRow" style="display:none"><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø´Ø¨ÙƒØ©</td><td style="text-align:left" id="paidCard"></td></tr>
              <tr id="paidRow" style="display:none"><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td style="text-align:left" id="paid"></td></tr>
              <tr id="changeRow" style="display:none"><td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</td><td style="text-align:left" id="change"></td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="qr"><img id="qrImg" alt="QR" style="max-width:100%; max-height:100%;"/></div>
      </div>

      <div id="generalNotesContainer" style="display:none; margin-top:8px; border:3px solid #000; border-radius:8px; padding:6px 8px; width:100%; box-sizing:border-box;">
        <div style="font-weight:900; margin-bottom:4px; color:#000; font-size:11px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>
        <div id="generalNotesContent" style="white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; color:#000; font-weight:700; font-size:10px; line-height:1.3;"></div>
      </div>

      <div class="footer">
      </div>
    </div>

    <script>
      function toTLV(tag, value){
        const enc = new TextEncoder();
        const valBytes = enc.encode(value || '');
        return [tag, valBytes.length, ...valBytes];
      }
      function genZatcaBase64(seller, vatNo, issueISO, total, vat){
        const parts = [];
        const _seller = String(seller||'');
        const _vat = String(vatNo||'');
        const _iso = String(issueISO||'');
        const _total = (Number(total||0)).toFixed(2);
        const _vatt = (Number(vat||0)).toFixed(2);
        parts.push(...toTLV(1, _seller));
        parts.push(...toTLV(2, _vat));
        parts.push(...toTLV(3, _iso));
        parts.push(...toTLV(4, _total));
        parts.push(...toTLV(5, _vatt));
        const arr = new Uint8Array(parts);
        let bin = '';
        for(let i=0;i<arr.length;i++){ bin += String.fromCharCode(arr[i]); }
        return btoa(bin);
      }

      (async function(){
        // Ø¯Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø­Ø¸Ø± Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨ (1-8 Ø«ÙˆØ§Ù†ÙŠ)
        function randomDelay(minMs, maxMs) {
          const delay = Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
          return new Promise(resolve => setTimeout(resolve, delay));
        }

        function showLowStockBanner(){
          try{
            const id = 'lowStockBanner';
            if(document.getElementById(id)) return;
            const div = document.createElement('div');
            div.id = id;
            div.textContent = 'ØªÙ†Ø¨ÙŠÙ‡: Ø¨Ø¹Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù‚Ø±Ø¨ Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
            div.style.position = 'fixed';
            div.style.top = '0';
            div.style.left = '0';
            div.style.right = '0';
            div.style.zIndex = '9999';
            div.style.background = '#f59e0b';
            div.style.color = '#000';
            div.style.textAlign = 'center';
            div.style.padding = '10px 12px';
            div.style.fontWeight = '800';
            div.style.borderBottom = '2px solid #b45309';
            document.body.appendChild(div);
            setTimeout(()=>{ try{ div.remove(); }catch(_){ } }, 3000);
          }catch(_){ }
        }
        const params = new URLSearchParams(location.search);
        const saleId = Number(params.get('id'));
        const pay = params.get('pay') || '';
        const cash = Number(params.get('cash')||0);
        try{
          const api = (window.opener && window.opener.api) ? window.opener.api : (window.api || {});
          
          // ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
          const [s, st, lg] = await Promise.all([
            api.sales_get(saleId),
            api.settings_get(),
            api.settings_image_get()
          ]);
          const settings = (st && st.ok) ? st.item : {};
          window.__SETTINGS__ = settings; // Cache for silent print WhatsApp
          // Apply global print margins (mm) via CSS variables
          try{
            const ml = Math.max(0, Number(settings.print_margin_left_mm||0));
            const mr = Math.max(0, Number(settings.print_margin_right_mm||0));
            document.documentElement.style.setProperty('--m-left', ml + 'mm');
            document.documentElement.style.setProperty('--m-right', mr + 'mm');
          }catch(_){ /* ignore */ }

          // Update unit price label from settings
          try{
            const unitPriceLabel = settings.unit_price_label || 'Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©';
            const thUnitPrice = document.getElementById('thUnitPrice');
            if(thUnitPrice) thUnitPrice.textContent = unitPriceLabel;
          }catch(_){ /* ignore */ }
          // Update quantity label from settings
          try{
            const quantityLabel = settings.quantity_label || 'Ø¹Ø¯Ø¯';
            const thQuantity = document.getElementById('thQuantity');
            if(thQuantity) thQuantity.textContent = quantityLabel;
          }catch(_){ /* ignore */ }

          // Rebind reprint button for silent mode and override inline onclick
          try{
            const reBtn = document.getElementById('reprintBtn');
            if(reBtn && settings && settings.silent_print){
              reBtn.onclick = async (ev) => {
                ev.preventDefault(); ev.stopPropagation();
                try{
                  const roomParam = params.get('room') || '';
                  const copies = Math.max(1, Number(settings.print_copies || (settings.print_two_copies ? 2 : 1)));
                  for(let i=1;i<=copies;i++){
                    await api.print_invoice_silent({ id: saleId, pay: (pay || (s.sale?.payment_method || '')), cash: String(cash), room: roomParam, format: 'a4' });
                  }
                }catch(_){ /* ignore */ }
                return false;
              };
            }
          }catch(_){ /* ignore */ }
          if(!s || !s.ok){ document.body.innerHTML = '<div style=\"padding:12px\">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>'; return; }
          const sale = s.sale, items = s.items || [];
          window.__SALE_DATA__ = sale; // Cache for silent print WhatsApp

          // ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØºØ±ÙØ© Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ (Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
          const roomId = params.get('room');
          const needsCustomer = sale.customer_id;
          
          const [customerDataPreload, roomDataPreload] = await Promise.all([
            needsCustomer ? api.customers_get(sale.customer_id) : Promise.resolve(null),
            roomId ? api.rooms_list() : Promise.resolve(null)
          ]);

          // Low-stock alert: check products.stock vs threshold (only if enabled in settings)
          try{
            if(settings && settings.show_low_stock_alerts === true){
              const threshold = Math.max(0, Number(settings.low_stock_threshold ?? 5));
              if(items && items.length && threshold >= 0){
                let low = false;
                for(const it of items){
                  try{
                    const pr = await api.products_get(it.product_id);
                    if(pr && pr.ok && pr.item){
                      const st = Number(pr.item.stock||0);
                      if(st <= threshold){ low = true; break; }
                    }
                  }catch(_){ }
                }
                if(low){ showLowStockBanner(); }
              }
            }
          }catch(_){ }

          // ÙÙŠ Ø­Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø®Ø²Ù†Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
          try{
            const isCredit = String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-');
            if(isCredit && !(Number(sale.discount_amount||0) > 0)){
              const baseId = Number(params.get('base')||0);
              let baseSale = null;
              if(baseId){ const br = await api.sales_get(baseId); if(br && br.ok){ baseSale = br.sale; } }
              if(!baseSale){
                const baseNo = params.get('base_no')||'';
                if(baseNo){
                  const lr = await api.sales_list({ invoice_no: baseNo });
                  if(lr && lr.ok && lr.items && lr.items.length){
                    const bid = lr.items[0].id;
                    const br2 = await api.sales_get(bid);
                    if(br2 && br2.ok){ baseSale = br2.sale; }
                  }
                }
              }
              if(baseSale){
                const bExtra = Number(baseSale.extra_value||0);
                const bDisc = Number(baseSale.discount_amount||0);
                if(bExtra > 0){
                  document.getElementById('extraRow').style.display='';
                  document.getElementById('extra').textContent = Number(bExtra).toFixed(2);
                }
                if(bDisc > 0){
                  document.getElementById('discRow').style.display='';
                  const blabel = (baseSale.discount_type === 'amount') ? 'Ø®ØµÙ… Ù†Ù‚Ø¯ÙŠ' : 'Ø®ØµÙ…';
                  document.getElementById('discLabel').textContent = blabel;
                  document.getElementById('disc').textContent = Number(Math.abs(bDisc)).toFixed(2);
                  document.getElementById('afterDisc').textContent = Number(Math.abs(baseSale.total_after_discount ?? (Number(baseSale.sub_total||0) - bDisc))).toFixed(2);
                  document.getElementById('afterDiscRow').style.display='';
                }
              }
            }
          }catch(_){ }

          function fmt(a){
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆÙ…ÙˆÙ‚Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const n = Number(a||0).toFixed(2);
            try{
              // Return plain number without any currency word/symbol
              return n;
            }catch(_){
              return n;
            }
          }

          // set order number if available
          try{
            const ord = Number(sale.order_no||0);
            if(ord>0){ const ordEl = document.getElementById('orderNo'); if(ordEl){ ordEl.textContent = String(ord); } }
          }catch(_){ }

          // header info (Arabic on right, English on left)
          try{
            const arName = settings.seller_legal_name || '';
            const enName = settings.seller_legal_name_en || arName;
            const arInfo = [];
            const enInfo = [];
            if(settings.company_location){ arInfo.push(settings.company_location); }
            if(settings.company_location_en || settings.company_location){ enInfo.push(settings.company_location_en || settings.company_location); }
            if(settings.company_site){ arInfo.push(settings.company_site); enInfo.push(settings.company_site); }
            if(settings.mobile){ arInfo.push('Ø¬ÙˆØ§Ù„: ' + settings.mobile); enInfo.push('Mobile: ' + settings.mobile); }
            if(settings.email && (typeof settings.show_email_in_invoice === 'undefined' || settings.show_email_in_invoice)){ arInfo.push('Ø¥ÙŠÙ…ÙŠÙ„: ' + settings.email); enInfo.push('Email: ' + settings.email); }
            if(settings.seller_vat_number){ arInfo.push('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: ' + settings.seller_vat_number); enInfo.push('VAT No: ' + settings.seller_vat_number); }
            if(settings.commercial_register){ arInfo.push('Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ: ' + settings.commercial_register); enInfo.push('CR No: ' + settings.commercial_register); }
            const arNameEl = document.getElementById('companyAr');
            const enNameEl = document.getElementById('companyEn');
            const arInfoEl = document.getElementById('companyInfoAr');
            const enInfoEl = document.getElementById('companyInfoEn');
            if(arNameEl) arNameEl.textContent = arName;
            if(enNameEl) enNameEl.textContent = enName;
            if(arInfoEl) arInfoEl.textContent = arInfo.join('\n');
            if(enInfoEl) enInfoEl.textContent = enInfo.join('\n');

            // Auto-fit long company texts to preserve header layout
            function fitText(el, maxLines, minPx, maxPx){
              if(!el) return;
              try{
                const cs = window.getComputedStyle(el);
                let fs = Math.min(maxPx, parseFloat(cs.fontSize) || maxPx);
                const baseLineH = parseFloat(cs.lineHeight) || (fs * 1.2);
                const maxH = Math.ceil(baseLineH * maxLines);
                el.style.maxHeight = maxH + 'px';
                // keep readable line-height while shrinking
                el.style.lineHeight = '1.15';
                // Shrink until content fits within max height
                while(el.scrollHeight > el.clientHeight && fs > minPx){
                  fs -= 1;
                  el.style.fontSize = fs + 'px';
                }
              }catch(_){ /* ignore */ }
            }
            // Names: keep within 2 lines (24px..14px)
            fitText(arNameEl, 2, 14, 24);
            fitText(enNameEl, 2, 14, 24);
            // Info blocks: keep within ~5 lines (13.5px..10px)
            fitText(arInfoEl, 5, 10, 13.5);
            fitText(enInfoEl, 5, 10, 13.5);
          }catch(_){ /* ignore */ }
          // logo (already loaded in parallel) + apply size
          const logoEl = document.getElementById('logo');
          try{
            if(lg && lg.ok && lg.base64){
              logoEl.src = `data:${lg.mime||'image/png'};base64,${lg.base64}`;
            } else if(settings.logo_path){
              if(settings.logo_path.startsWith('assets/')){
                logoEl.src='../../../'+settings.logo_path;
              }else{
                logoEl.src='file:///'+String(settings.logo_path||'').replace(/\\/g,'/');
              }
            } else {
              logoEl.style.display='none';
            }
            const lw = Number(settings.logo_width_px||0), lh = Number(settings.logo_height_px||0);
            if(lw>0){ logoEl.style.width = lw + 'px'; }
            if(lh>0){ logoEl.style.height = lh + 'px'; }
          }catch(_){ logoEl.style.display='none'; }

          // footer note from settings + invoice notes from the sale
          try{
            const settingsNote = (settings && settings.invoice_footer_note || '').trim();
            const saleNote = (sale && sale.notes || '').trim();
            
            // Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø³ÙÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            const invoiceNotesContainer = document.getElementById('invoiceNotesContainer');
            const invoiceNotesContent = document.getElementById('invoiceNotesContent');
            if(saleNote){
              invoiceNotesContent.textContent = saleNote;
              invoiceNotesContainer.style.display = 'block';
            } else {
              invoiceNotesContainer.style.display = 'none';
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ Ù…Ø±Ø¨Ø¹ Ù…Ù†ÙØµÙ„ Ø¨Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ±Ù‚Ø©
            const generalNotesContainer = document.getElementById('generalNotesContainer');
            const generalNotesContent = document.getElementById('generalNotesContent');
            if(settingsNote){
              generalNotesContent.textContent = settingsNote;
              generalNotesContainer.style.display = 'block';
            } else {
              generalNotesContainer.style.display = 'none';
            }
          }catch(_){}

          document.getElementById('invNo').textContent = sale.invoice_no;
          // Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†ØŒ Ø§Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
          const baseNo = params.get('base_no') || sale.ref_base_invoice_no || '';
          if(String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-')){
            if(baseNo){ document.getElementById('invNo').textContent = baseNo; }
          }
          // Gregorian date in English (Gregorian)
          // 12-hour time with AM/PM in English
          const enGreg = new Intl.DateTimeFormat('en-GB-u-ca-gregory', { year:'numeric', month:'2-digit', day:'2-digit', hour:'numeric', minute:'2-digit', hour12:true }).format(new Date(sale.created_at));
          document.getElementById('invDate').textContent = enGreg;
          // Show paid timestamp if settled
          // Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© ÙÙŠ settled_at (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©)
          try{
            const line = document.getElementById('paidAtLine');
            if(sale.settled_at){
              const paidFmt = new Intl.DateTimeFormat('en-GB-u-ca-gregory', { year:'numeric', month:'2-digit', day:'2-digit', hour:'numeric', minute:'2-digit', hour12:true }).format(new Date(sale.settled_at));
              document.getElementById('paidAt').textContent = paidFmt;
              if(line) line.style.display = '';
            } else {
              if(line) line.style.display = 'none';
            }
          }catch(_){ }
          // Ø®Ø±ÙŠØ·Ø© Ø¹Ø±Ø¨ÙŠØ© Ù„Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
          const payLabels = { cash:'ÙƒØ§Ø´', card:'Ø´Ø¨ÙƒØ©', credit:'Ø¢Ø¬Ù„', mixed:'Ù…Ø®ØªÙ„Ø·', tamara:'ØªÙ…Ø§Ø±Ø§', tabby:'ØªØ§Ø¨ÙŠ', refund:'Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†' };
          const payKey = pay || sale.payment_method || '';
          document.getElementById('invPay').textContent = payLabels[payKey] || payKey;
          // Show cashier (logged-in user) full name from localStorage if available
          try{
            const u = JSON.parse(localStorage.getItem('pos_user')||'null');
            if(u && (u.full_name || u.username)){
              const line = document.getElementById('userLineA4');
              const span = document.getElementById('cashierNameA4');
              if(span){ span.textContent = u.full_name || u.username; }
              if(line){ line.style.display = 'flex'; }
            }
          }catch(_){ /* ignore */ }
          // room name (already loaded in parallel)
          if(roomDataPreload && roomDataPreload.ok){
            try{
              const R = (roomDataPreload.items||[]).find(x => String(x.id)===String(roomId));
              if(R){
                document.getElementById('roomName').textContent = R.name;
                document.getElementById('roomLine').hidden = false;
              }
            }catch(_){ /* ignore */ }
          }

          // driver (single line)
          try{
            if(sale.driver_name || sale.driver_phone){
              const title = document.getElementById('driverTitle');
              const box = document.getElementById('driverDetails');
              if(title) title.style.display='block';
              if(box) box.style.display='block';
              document.getElementById('drvA4Name').textContent = sale.driver_name || '';
              document.getElementById('drvA4Phone').textContent = sale.driver_phone || '';
            }
          }catch(_){}

          // customer details block (formatted list) Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù… + ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          try{
            let vatNo = '';
            // Always reset customer UI to hidden to avoid leftovers when no customer data
            try{
              const title = document.getElementById('customerTitle');
              const box = document.getElementById('custBox');
              if(title) title.style.display = 'none';
              if(box){
                box.style.display = 'none';
                const ids = ['a4cName','a4cPhone','a4cEmail','a4cAddress','a4cVat','a4cCR','a4cNat','a4cNotes'];
                ids.forEach(id => {
                  const el = document.getElementById(id);
                  if(!el) return;
                  el.style.display = 'none';
                  if(id === 'a4cName'){
                    el.textContent = '';
                    el.style.gridColumn = '';
                    el.style.background = '';
                    el.style.fontWeight = '';
                    el.style.borderBottom = '';
                  } else {
                    const span = el.querySelector('span');
                    if(span) span.textContent = '';
                  }
                });
              }
            }catch(_){ /* ignore */ }
            if(sale.customer_id || sale.customer_name){
              // ğŸš€ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
              let customerData = null;
              if(customerDataPreload && customerDataPreload.ok && customerDataPreload.item){
                customerData = customerDataPreload.item;
              }
              if(!customerData && sale.customer_name){
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ sales Ù…Ø¨Ø§Ø´Ø±Ø©
                customerData = {
                  name: sale.customer_name,
                  phone: sale.customer_phone,
                  email: sale.customer_email,
                  address: sale.customer_address,
                  vat_number: sale.customer_vat_number || sale.customer_vat,
                  cr_number: sale.customer_cr_number,
                  national_address: sale.customer_national_address,
                  postal_code: sale.customer_postal_code,
                  street_number: sale.customer_street_number,
                  sub_number: sale.customer_sub_number,
                  customer_notes: sale.customer_notes
                };
              }
              
              if(customerData){
                const { name, phone, email, address, vat_number, cr_number, national_address, postal_code, street_number, sub_number } = customerData;
                const custNotes = customerData.notes || customerData.customer_notes || null;
                window.__CUST_PHONE__ = (phone || '').trim(); // Cache for WhatsApp
                vatNo = vat_number || '';
                const box = document.getElementById('custBox');
                const cName = document.getElementById('a4cName');
                const cPhone = document.getElementById('a4cPhone');
                const cEmail = document.getElementById('a4cEmail');
                const cAddress = document.getElementById('a4cAddress');
                const cVat = document.getElementById('a4cVat');
                const cCR = document.getElementById('a4cCR');
                const cNat = document.getElementById('a4cNat');
                const cPostal = document.getElementById('a4cPostal');
                const cStreet = document.getElementById('a4cStreet');
                const cSub = document.getElementById('a4cSub');
                const cNotes = document.getElementById('a4cNotes');
                if(name){ cName.textContent = 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + name; cName.style.display='block'; cName.style.gridColumn='auto'; cName.style.background=''; cName.style.fontWeight='900'; cName.style.borderBottom=''; } else { cName.style.display='none'; }
                if(phone){ cPhone.style.display='block'; cPhone.querySelector('span').textContent = phone; }
                if(email){ cEmail.style.display='block'; cEmail.querySelector('span').textContent = email; }
                if(address){ cAddress.style.display='block'; cAddress.querySelector('span').textContent = address; }
                if(vat_number){ cVat.style.display='block'; cVat.querySelector('span').textContent = vat_number; }
                if(cr_number){ cCR.style.display='block'; cCR.querySelector('span').textContent = cr_number; }
                if(national_address){ cNat.style.display='block'; cNat.querySelector('span').textContent = national_address; }
                if(postal_code){ cPostal.style.display='block'; cPostal.querySelector('span').textContent = postal_code; }
                if(street_number){ cStreet.style.display='block'; cStreet.querySelector('span').textContent = street_number; }
                if(sub_number){ cSub.style.display='block'; cSub.querySelector('span').textContent = sub_number; }
                if(custNotes){ cNotes.style.display='block'; cNotes.querySelector('span').textContent = custNotes; }
                const hasAny = (name||phone||email||address||vat_number||cr_number||national_address||postal_code||street_number||sub_number||custNotes);
                if(hasAny){ box.style.display = 'grid'; }
                const title = document.getElementById('customerTitle');
                if(hasAny && title){ title.style.display = 'block'; }
              }
            }
            // Ø¥Ø¸Ù‡Ø§Ø± Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const typeEl = document.getElementById('invType');
            const hasVat = Number(sale.vat_total||0) > 0;
            if(String(sale.invoice_no||'').startsWith('CN-') || String(sale.doc_type||'')==='credit_note'){
              const baseNo = params.get('base_no') || sale.ref_base_invoice_no || '';
              const cn = String(sale.invoice_no||'');
              const hasVatAbs = Math.abs(Number(sale.vat_total||0)) > 0;
              let label = 'Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†';
              let hasCustomerVat = !!vatNo; // Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø£Ø¹Ù„Ø§Ù‡
              if(hasVatAbs){ label = hasCustomerVat ? 'Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù† Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ©' : 'Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù† Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©'; }
              typeEl.textContent = label;
              const below = document.createElement('div');
              below.className = 'muted'; below.style.marginTop='6px'; below.style.fontSize='12px';
              const cnNum = cn.replace(/^CN-?/i, '');
              below.textContent = baseNo ? `Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${cnNum} â€” Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: ${baseNo}` : `Ø±Ù‚Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${cnNum}`;
              typeEl.parentElement.appendChild(below);
              typeEl.style.display = '';
            } else if(hasVat){
              typeEl.textContent = vatNo ? 'ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©' : 'ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©';
              typeEl.style.display = '';
            } else {
              typeEl.style.display = 'none';
            }
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø±Ø© Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª = 0
            try{ if(Number(settings?.vat_percent||0) === 0){ typeEl.style.display = 'none'; } }catch(_){ /* ignore */ }
          }catch(_){ /* ignore */ }
          // Ø®Ø±ÙŠØ·Ø© Ø¹Ø±Ø¨ÙŠØ© Ù„Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
          const payLabels2 = { cash:'ÙƒØ§Ø´', card:'Ø´Ø¨ÙƒØ©', credit:'Ø¢Ø¬Ù„', mixed:'Ù…Ø®ØªÙ„Ø·', tamara:'ØªÙ…Ø§Ø±Ø§', tabby:'ØªØ§Ø¨ÙŠ' };
          const payKey2 = pay || sale.payment_method || '';
          document.getElementById('invPay').textContent = payLabels2[payKey2] || payKey2;

          const tbody = document.getElementById('items');
          // Ø§Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø§Ù„Ø¹Ù…Ù„ÙŠØ©) Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          try{
            const itemsTable = document.getElementById('itemsTable');
            const hasOp = Array.isArray(items) && items.some(it => String(it.operation_name||'').trim() !== '');
            const vatPercent = Number(settings?.vat_percent || 0);
            const showBarcode = (settings?.show_barcode_in_a4 === 1);
            if(itemsTable){
              // Ù„Ø§ ØªÙØ·Ø¨Ù‚ no-op ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¶Ø±ÙŠØ¨Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØ®ØªÙÙŠ Ø¹Ù…ÙˆØ¯ "Ø¹Ø¯Ø¯"
              itemsTable.classList.remove('has-op','no-op');
              itemsTable.classList.toggle('hide-barcode', !showBarcode);
              if(vatPercent > 0){
                itemsTable.classList.add(hasOp ? 'has-op' : 'no-op');
              }
              itemsTable.classList.toggle('no-vat', vatPercent === 0);
              if(vatPercent === 0){
                const thead = itemsTable.querySelector('thead');
                if(thead){
                  const headerRows = thead.querySelectorAll('tr');
                  const unitPriceLabel = settings.unit_price_label || 'Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©';
                  const quantityLabel = settings.quantity_label || 'Ø¹Ø¯Ø¯';
                  if(hasOp){
                    // 6 Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø§Ù„ØµÙ†ÙØŒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø¹Ø¯Ø¯ØŒ Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    if(headerRows[0]){
                      headerRows[0].innerHTML = `
                        <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th>${quantityLabel}</th>
                        <th>${unitPriceLabel}</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                      `;
                    }
                  } else {
                    // 5 Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø§Ù„ØµÙ†ÙØŒ Ø¹Ø¯Ø¯ØŒ Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    if(headerRows[0]){
                      headerRows[0].innerHTML = `
                        <th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>${quantityLabel}</th>
                        <th>${unitPriceLabel}</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                      `;
                    }
                  }
                }
              }
            }
          }catch(_){ /* ignore */ }
          const isCredit = String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-');

          // Ù‡Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©ØŸ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù†Ø¹Ù… Ø¥Ù† Ù„Ù… ÙŠÙØ°ÙƒØ± Ø§Ù„Ø¹ÙƒØ³
          // Parse robustly: supports 0/1, '0'/'1', true/false, 'true'/'false' (case-insensitive). Default = true if unset.
          let pricesInclVat = true;
          try{
            const v = settings ? settings.prices_include_vat : undefined;
            if (v == null) {
              pricesInclVat = true;
            } else if (typeof v === 'boolean') {
              pricesInclVat = v;
            } else if (typeof v === 'number') {
              pricesInclVat = Number(v) === 1;
            } else if (typeof v === 'string') {
              const sv = v.toLowerCase().trim();
              pricesInclVat = (sv === 'true' || sv === '1' || sv === 'yes');
            } else {
              pricesInclVat = !!Number(v);
            }
          }catch(_){ pricesInclVat = true; }
          const vatRate = Number(settings?.vat_percent || 0) / 100;

          items.forEach(it => {
            // Ø§Ù„ØµÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¨Ù†Ø¯
            const tr = document.createElement('tr');
            tr.className = 'item-row';
            const opCell = it.operation_name ? it.operation_name : '';
            // ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù†: Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ù…Ø·Ù„Ù‚
            const unitPriceRaw = Number(it.price||0);
            const qtyVal = it.qty;
            // Normalize qty from possible Arabic digits and separators
            let qtyNum = 0;
            try{
              let s = (qtyVal==null ? '' : String(qtyVal)).trim();
              if(s){
                const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9','âˆ’':'-'};
                s = s.replace(/[Ù -Ù©Û°-Û¹âˆ’]/g, ch => map[ch] || ch);
                s = s.replace(/[\u200e\u200f\u202a-\u202e\u2066-\u2069]/g, ''); // strip bidi control chars
                s = s.replace(/[Ù¬\s]/g,''); // thousands/grouping
                s = s.replace(/[Ù«,]/g,'.');   // decimal to dot
                s = s.replace(/[^0-9.\-]/g,''); // keep only digits, dot, minus
                const t = parseFloat(s);
                qtyNum = Number.isFinite(t) ? t : (typeof qtyVal === 'number' ? qtyVal : Number(qtyVal||0));
              } else {
                qtyNum = (typeof qtyVal === 'number') ? qtyVal : Number(qtyVal||0);
              }
            }catch(_){ qtyNum = (typeof qtyVal === 'number') ? qtyVal : Number(qtyVal||0); }
            qtyNum = isCredit ? Math.abs(qtyNum) : qtyNum;
            const unitPrice = isCredit ? Math.abs(unitPriceRaw) : unitPriceRaw;

            // Ù†Ø­Ø³Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø³Ø·Ø± (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©) ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            // Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø©: Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± (line_total)
            const lineTotalRaw = Number(it.line_total|| (unitPrice * qtyNum));
            const lineTotal = isCredit ? Math.abs(lineTotalRaw) : lineTotalRaw;
            let net = 0, vatAmt = 0, gross = 0;
            if(vatRate > 0){
              if(pricesInclVat){
                // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ´Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© -> ØµØ§ÙÙŠ = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ / (1+Ù†Ø³Ø¨Ø©) ØŒ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø§Ù„ØµØ§ÙÙŠ
                net = lineTotal / (1 + vatRate);
                vatAmt = lineTotal - net;
                gross = lineTotal;
              }else{
                // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© -> ØµØ§ÙÙŠ = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØŒ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© = ØµØ§ÙÙŠ * Ù†Ø³Ø¨Ø© ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = ØµØ§ÙÙŠ + Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
                net = lineTotal;
                vatAmt = net * vatRate;
                gross = net + vatAmt;
              }
            }else{
              // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ø±ÙŠØ¨Ø©
              net = lineTotal;
              vatAmt = 0;
              gross = lineTotal;
            }

            // Quantity text: no decimals if integer; otherwise 3 decimals
            const qtyTxt = Number.isInteger(qtyNum) ? String(qtyNum) : qtyNum.toFixed(3);
            const vatRateTxt = (vatRate>0) ? (vatRate*100).toFixed(0) : '0';
            const empName = it.employee_name ? `<div style='font-size:12px; color:#64748b; margin-top:2px; font-weight:700;'>Ø§Ù„Ù…ÙˆØ¸Ù: ${it.employee_name}</div>` : '';

            // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© = ØµØ§ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© Ù‡Ù†Ø§)
            const displayNet = net;
            // Render cells based on VAT presence: with VAT â†’ 8 columns; no VAT â†’ 4 or 5 columns (with Operation if present)
            if(vatRate > 0){
              tr.innerHTML = `
                <td class="barcode-cell">${it.barcode||''}</td>
                <td>
                  <div class="item-name">${it.name||''}</div>
                  ${it.name_en ? `<div class="item-name-en">${it.name_en}</div>` : ''}
                  ${(it.description || Number(it.is_tobacco||0) || it.employee_name) ? `<div class="desc-print">${Number(it.is_tobacco||0) ? `<span style='color:#b91c1c; font-weight:800; margin-inline-end:10px;'>Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù ÙŠØ·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ¨Øº</span>` : ''}${it.description ? `<span class="desc-title">ÙˆØµÙ Ø§Ù„ØµÙ†Ù:</span> ${it.description}` : ''}${empName}</div>` : ''}
                </td>
                <td>${opCell}</td>
                <td class="num">${qtyTxt}</td>
                <td class="num">${fmt(unitPrice)}</td>
                <td class="num">${fmt(displayNet)}</td>
                <td class="num">${vatRateTxt}</td>
                <td class="num">${fmt(vatAmt)}</td>
                <td class="num">${fmt(gross)}</td>
              `;
            } else {
              // When VAT is 0%, include Operation column if any item has operation_name (align rows with header logic)
              const hasOpOverall = Array.isArray(items) && items.some(x => String(x.operation_name||'').trim() !== '');
              if(hasOpOverall){
                tr.innerHTML = `
                  <td class="barcode-cell">${it.barcode||''}</td>
                  <td>
                    <div class="item-name">${it.name||''}</div>
                    ${it.name_en ? `<div class="item-name-en">${it.name_en}</div>` : ''}
                    ${(it.description || Number(it.is_tobacco||0) || it.employee_name) ? `<div class="desc-print">${Number(it.is_tobacco||0) ? `<span style='color:#b91c1c; font-weight:800; margin-inline-end:10px;'>Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù ÙŠØ·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ¨Øº</span>` : ''}${it.description ? `<span class=\"desc-title\">ÙˆØµÙ Ø§Ù„ØµÙ†Ù:</span> ${it.description}` : ''}${empName}</div>` : ''}
                  </td>
                  <td>${opCell}</td>
                  <td class="num">${qtyTxt}</td>
                  <td class="num">${fmt(unitPrice)}</td>
                  <td class="num">${fmt(gross)}</td>
                `;
              } else {
                tr.innerHTML = `
                  <td class="barcode-cell">${it.barcode||''}</td>
                  <td>
                    <div class="item-name">${it.name||''}</div>
                    ${it.name_en ? `<div class="item-name-en">${it.name_en}</div>` : ''}
                    ${(it.description || Number(it.is_tobacco||0) || it.employee_name) ? `<div class="desc-print">${Number(it.is_tobacco||0) ? `<span style='color:#b91c1c; font-weight:800; margin-inline-end:10px;'>Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù ÙŠØ·Ø¨Ù‚ Ø¹Ù„ÙŠÙ‡ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ¨Øº</span>` : ''}${it.description ? `<span class=\"desc-title\">ÙˆØµÙ Ø§Ù„ØµÙ†Ù:</span> ${it.description}` : ''}${empName}</div>` : ''}
                  </td>
                  <td class="num">${qtyTxt}</td>
                  <td class="num">${fmt(unitPrice)}</td>
                  <td class="num">${fmt(gross)}</td>
                `;
              }
            }
            tbody.appendChild(tr);


          });

          // Autosize numeric cells to fit width (shrink large, enlarge small)
          function __adjustNumCells(){
            try{
              const minPx = 10, maxPx = 16;
              const cells = document.querySelectorAll('#itemsTable tbody td.num');
              cells.forEach(td => {
                // Start large, then shrink if needed
                let size = maxPx;
                td.style.fontSize = size + 'px';
                // Shrink if overflow
                for(let i=0;i<20 && td.scrollWidth > td.clientWidth && size > minPx; i++){
                  size -= 0.5;
                  td.style.fontSize = size + 'px';
                }
                // If there's ample space, grow a bit (but don't overflow)
                for(let i=0;i<12 && (td.scrollWidth * 1.08) < td.clientWidth && size < maxPx; i++){
                  size += 0.5;
                  td.style.fontSize = size + 'px';
                  if(td.scrollWidth > td.clientWidth){
                    size -= 0.5;
                    td.style.fontSize = size + 'px';
                    break;
                  }
                }
              });
            }catch(_){ /* ignore */ }
          }
          requestAnimationFrame(() => { __adjustNumCells(); });
          window.addEventListener('resize', () => { __adjustNumCells(); });
          window.addEventListener('beforeprint', () => { __adjustNumCells(); });

          const subValRaw = Number(sale.sub_total||0);
          document.getElementById('sub').innerHTML = fmt(isCredit ? Math.abs(subValRaw) : subValRaw);
          // extra value row
          const extraVal = Number(sale.extra_value||0);
          if(extraVal > 0){
            document.getElementById('extraRow').style.display='';
            document.getElementById('extra').innerHTML = fmt(extraVal);
          }
          // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙ‚Ø·ØŒ ÙˆØ£Ø®ÙÙ Ø£ÙŠ Ø£Ø«Ø± Ù„Ù„ÙƒÙˆØ¨ÙˆÙ† ÙÙŠ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
          if(Number(sale.discount_amount||0) > 0){
            document.getElementById('discRow').style.display='';
            const label = (sale.discount_type === 'amount') ? 'Ø®ØµÙ… Ù†Ù‚Ø¯ÙŠ' : 'Ø®ØµÙ…';
            document.getElementById('discLabel').textContent = label;
            document.getElementById('disc').innerHTML = fmt(Math.abs(Number(sale.discount_amount||0)));
            document.getElementById('afterDiscRow').style.display='';
          }
          const afterDiscValRaw = Number(sale.total_after_discount ?? (Number(sale.sub_total||0) - Number(sale.discount_amount||0)));
          document.getElementById('afterDisc').innerHTML = fmt(isCredit ? Math.abs(afterDiscValRaw) : afterDiscValRaw);
          // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ¨Øº Ø¥Ù† ÙˆÙØ¬Ø¯Øª
          try{
            const feeRow = document.getElementById('tobaccoFeeRow');
            const feeVal = document.getElementById('tobaccoFee');
            // ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù†ØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø©Ø› Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©
            const rawTf = Number(sale.tobacco_fee || 0);
            const tf = (String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-')) ? Math.abs(rawTf) : rawTf;
            if(feeRow && feeVal){
              if(tf > 0){
                feeRow.style.display='';
                try{
                  feeVal.innerHTML = fmt(tf);
                }catch(_){ feeVal.textContent = fmt(tf); }
              }
              else { feeRow.style.display='none'; feeVal.textContent = ''; }
            }
          }catch(_){ }
          // ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù†: Ø§Ø¹Ø±Ø¶ VAT ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ… Ù…ÙˆØ¬Ø¨Ø©
          const isCreditAbs = String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-');
          document.getElementById('vat').innerHTML = fmt(isCreditAbs ? Math.abs(Number(sale.vat_total||0)) : Number(sale.vat_total||0));
          // Ø¥Ø®ÙØ§Ø¡ ØµÙ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© = 0 ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          try{
            if(Number(settings?.vat_percent||0) === 0){
              const vatRow = document.getElementById('vat')?.closest('tr');
              if(vatRow){ vatRow.style.display = 'none'; }
            }
          }catch(_){ /* ignore */ }
          const afterDiscForGrand = Number(sale.total_after_discount ?? (Number(sale.sub_total||0) - Number(sale.discount_amount||0) + Number(sale.tobacco_fee||0)));
          const computedGrand = Number(sale.grand_total ?? (afterDiscForGrand + Number(sale.vat_total||0)));
          document.getElementById('grand').innerHTML = fmt(isCreditAbs ? Math.abs(computedGrand) : computedGrand);

          // Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¶Ø±ÙŠØ¨Ø©: Ø£Ø¹ÙØ¯ ØªØ³Ù…ÙŠØ© Ø§Ù„ØµÙÙˆÙ ÙˆØ£Ø®ÙÙ ØµÙ "Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…"
          try{
            if(Number(settings?.vat_percent||0) === 0){
              const subLabel = document.getElementById('sub')?.previousElementSibling;
              if(subLabel){ subLabel.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'; }
              const afterDiscRowEl = document.getElementById('afterDiscRow');
              if(afterDiscRowEl){ afterDiscRowEl.style.display = 'none'; }
              const grandLabel = document.getElementById('grand')?.previousElementSibling;
              if(grandLabel){ grandLabel.innerHTML = '<b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b>'; }
            }
          }catch(_){ /* ignore */ }

          // paid and remaining
          const changeEl = document.getElementById('change');
          const changeRow = document.getElementById('changeRow');
          const isMixed = (pay||'')==='mixed';
          
          const dbPaid = Number(sale.paid_amount||0);
          const dbRemain = Number(sale.remaining_amount||0);

          if(dbPaid > 0 || dbRemain > 0 || sale.payment_status === 'partial'){
            const paidRow = document.getElementById('paidRow');
            const paidEl = document.getElementById('paid');
            if(dbPaid > 0){ paidEl.innerHTML = fmt(dbPaid); paidRow.style.display=''; } else { try{ paidRow.style.display='none'; }catch(_){} }
            if(dbRemain > 0){ changeRow.querySelector('td:first-child').textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'; changeEl.innerHTML = fmt(dbRemain); changeRow.style.display=''; } else { try{ changeRow.style.display='none'; }catch(_){} }
          } else if(!isMixed){
            const pm = (pay||'');
            const grand = Number(sale.grand_total||0);
            let paid = 0, remaining = 0, change = 0;
            if(pm === 'cash'){
              const entered = (cash>0) ? Number(cash) : 0;
              if(entered > 0){
                paid = entered;
                if(entered >= grand){
                  change = Number((entered - grand).toFixed(2));
                  remaining = 0;
                } else {
                  remaining = Number((grand - entered).toFixed(2));
                  change = 0;
                }
              }
            } else if(pm === 'card' || pm === 'tamara' || pm === 'tabby'){
              const entered = (cash>0) ? Number(cash) : 0;
              if(entered > 0){
                paid = entered;
                if(entered >= grand){
                  change = Number((entered - grand).toFixed(2));
                  remaining = 0;
                } else {
                  remaining = Number((grand - entered).toFixed(2));
                  change = 0;
                }
              } else {
                paid = grand;
                remaining = 0;
                change = 0;
              }
            } else if(pm === 'credit'){
              paid = 0;
              remaining = grand;
              change = 0;
            } else {
              paid = 0;
              remaining = grand;
              change = 0;
            }
            const paidRow = document.getElementById('paidRow');
            const paidEl = document.getElementById('paid');
            changeRow.querySelector('td:first-child').textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ';
            const forceChange = (pm === 'credit');
            const showChange = forceChange || (settings.print_show_change !== 0);
            if(showChange){
              if(forceChange){
                paidEl.innerHTML = fmt(0);
                paidRow.style.display='';
                changeEl.innerHTML = fmt(grand);
                changeRow.style.display='';
              }else{
                if(remaining > 0){
                  paidEl.innerHTML = fmt(paid);
                  paidRow.style.display='';
                  changeRow.querySelector('td:first-child').textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ';
                  changeEl.innerHTML = fmt(remaining);
                  changeRow.style.display='';
                } else if(change > 0){
                  changeRow.querySelector('td:first-child').textContent = 'Ø§Ù„Ø¨Ø§Ù‚ÙŠ';
                  changeEl.innerHTML = fmt(change);
                  changeRow.style.display='';
                }
              }
            }
          } else {
            try{ changeRow.style.display='none'; }catch(_){ }
          }

          // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ù…Ø®ØªÙ„Ø·: Ù†Ù‚Ø¯ÙŠ + Ø´Ø¨ÙƒØ©
          try{
            if(isMixed){
              // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø· Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
              let mp = null; try{ mp = window.opener?.__mixed_payment || null; }catch(_){ }
              // Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
              if(!mp){
                const cashSplit = Number(sale.pay_cash_amount||0);
                const cardSplit = Number(sale.pay_card_amount||0);
                if(cashSplit>0 || cardSplit>0){ mp = { cash: cashSplit, card: cardSplit }; }
              }
              if(mp){
                const cashRow = document.getElementById('paidCashRow');
                const cashCell = document.getElementById('paidCash');
                const cardRow = document.getElementById('paidCardRow');
                const cardCell = document.getElementById('paidCard');
                if(cashRow && cashCell && cardRow && cardCell){
                  cashRow.style.display=''; cashCell.textContent = fmt(mp.cash);
                  cardRow.style.display=''; cardCell.textContent = fmt(mp.card);
                } else {
                  const totals = document.querySelector('.totals tbody');
                  const r1 = document.createElement('tr'); r1.innerHTML = `<td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ø´</td><td style=\"text-align:left\">${fmt(mp.cash)}</td>`; totals.appendChild(r1);
                  const r2 = document.createElement('tr'); r2.innerHTML = `<td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø´Ø¨ÙƒØ©</td><td style=\"text-align:left\">${fmt(mp.card)}</td>`; totals.appendChild(r2);
                }
              }
            }
          }catch(_){ }

          // legacy inline invoice notes block was removed; handled above in unified notes section
          // ZATCA QR (offline generation)
          try{
            const qrBox = document.querySelector('.qr');
            const qrImg = document.getElementById('qrImg');
            if(settings.seller_legal_name && settings.seller_vat_number){
              const issueISO = new Date(sale.created_at).toISOString();
              const b64 = genZatcaBase64(settings.seller_legal_name, settings.seller_vat_number, issueISO, sale.grand_total, sale.vat_total);
              try{
                const svg = await api.qr_to_svg(b64, { width: 120, margin: 1 });
                if(svg && typeof svg === 'string'){
                  // Replace <img> with inline SVG for crisp print
                  const wrapper = document.createElement('div');
                  wrapper.style.width='120px'; wrapper.style.height='120px';
                  wrapper.innerHTML = svg;
                  qrImg.replaceWith(wrapper);
                  window.__QR_READY = true;
                } else {
                  const dataUrl = await api.qr_to_data_url(b64, { errorCorrectionLevel: 'M', width: 120, margin: 1 });
                  if(dataUrl){
                    qrImg.alt = 'ZATCA QR';
                    qrImg.src = dataUrl;
                    qrImg.addEventListener('load', () => { window.__QR_READY = true; }, { once: true });
                  }else{
                    throw new Error('QR generation failed');
                  }
                }
              }catch(e){
                qrImg.remove();
                const pre = document.createElement('pre');
                pre.textContent = 'ZATCA QR (Base64):\n' + b64;
                pre.style.fontSize = '10px';
                pre.style.direction = 'ltr';
                qrBox.appendChild(pre);
                window.__QR_READY = true;
              }
            } else {
              qrImg.remove();
            }
          }catch(_){ /* ignore */ }

          // Hook export PDF (A4) button
          try{
            const exportBtn = document.getElementById('exportBtn');
            if(exportBtn){
              exportBtn.addEventListener('click', async () => {
                try{
                  const root = document.documentElement.cloneNode(true);
                  Array.from(root.querySelectorAll('script')).forEach(s=>s.remove());
                  Array.from(root.querySelectorAll('.reprint-btn, .export-btn, .whats-btn')).forEach(el=>el.remove());
                  try{
                    const img = root.querySelector('#logo');
                    if(img){
                      let absLogo = '';
                      if(settings.logo_path){
                        if(String(settings.logo_path).startsWith('assets/')){
                          const rp = await api.resolve_path(settings.logo_path);
                          if(rp && rp.ok){ absLogo = 'file:///' + String(rp.abs||'').replace(/\\/g,'/'); }
                        }else{
                          absLogo = 'file:///' + String(settings.logo_path||'').replace(/\\/g,'/');
                        }
                      }
                      if(absLogo){ img.src = absLogo; }
                    }
                  }catch(_){ }
                  const html = '<!doctype html>' + root.outerHTML;
                  const fname = `invoice-${sale.invoice_no}.pdf`;
                  const r = await window.opener?.api?.pdf_export(html, { pageSize: 'A4', printBackground: true, saveMode: 'auto', filename: fname });
                  if(!r || !r.ok){ alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„Ù„ÙØ§ØªÙˆØ±Ø©'); }
                }catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF'); }
              });
            }
          }catch(_){ }

          function showA4Notification(type, message) {
            if(!document.getElementById('a4-notif-styles')){
              const s = document.createElement('style');
              s.id = 'a4-notif-styles';
              s.textContent = `
                @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }
              `;
              document.head.appendChild(s);
            }
            let container = document.getElementById('a4-notif-container');
            if(!container){
              container = document.createElement('div');
              container.id = 'a4-notif-container';
              container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:999999;max-width:380px;pointer-events:none;';
              document.body.appendChild(container);
            }
            const colors = {
              success: 'linear-gradient(135deg,#25D366 0%,#128C7E 100%)',
              error:   'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)',
              warning: 'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)',
              info:    'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)'
            };
            const card = document.createElement('div');
            card.style.cssText = `background:${colors[type]||colors.info};color:white;padding:16px 20px;border-radius:12px;margin-bottom:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideInRight 0.5s ease-out;pointer-events:auto;direction:rtl;font-family:'Cairo',system-ui,sans-serif;display:flex;align-items:flex-start;gap:10px;`;
            card.innerHTML = `<span style="flex:1;font-size:14px;font-weight:600;line-height:1.5;">${message}</span><button style="background:rgba(255,255,255,0.25);border:none;color:white;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">Ã—</button>`;
            const closeBtn = card.querySelector('button');
            const dismiss = () => {
              card.style.animation = 'slideOutRight 0.4s ease-in forwards';
              setTimeout(() => card.remove(), 400);
            };
            const timer = setTimeout(dismiss, 5000);
            closeBtn.addEventListener('click', () => { clearTimeout(timer); dismiss(); });
            container.appendChild(card);
          }

          // WhatsApp button handler
          try{
            const whatsBtn = document.getElementById('whatsBtn');
            if(whatsBtn){
              whatsBtn.addEventListener('click', () => {
                (async () => {
                  try{
                    if(window.__WA_SENDING__){
                      showA4Notification('warning', 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                      return;
                    }

                    if(!navigator.onLine){
                      showA4Notification('error', 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                      return;
                    }

                    const statusCheck = await api.whatsapp_status();
                    if(!statusCheck || !statusCheck.success || !statusCheck.connected){
                      showA4Notification('error', 'âŒ WhatsApp ØºÙŠØ± Ù…ØªØµÙ„! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© WhatsApp ÙˆØ±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.');
                      return;
                    }

                    let rawPhone = String(sale.customer_phone || '').trim();
                    if(/^05\d{8}$/.test(rawPhone)){ 
                      rawPhone = '966' + rawPhone.slice(1); 
                    }
                    rawPhone = rawPhone.replace(/[^\d+]/g,'');
                    if(!rawPhone){ 
                      showA4Notification('warning', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„'); 
                      return; 
                    }

                    window.__WA_SENDING__ = true;
                    false && console.log('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©...');

                    (async () => {
                      try{
                        const root = document.documentElement.cloneNode(true);
                        Array.from(root.querySelectorAll('script')).forEach(s=>s.remove());
                        Array.from(root.querySelectorAll('.reprint-btn, .export-btn, .whats-btn')).forEach(el=>el.remove());
                        
                        try{
                          const img = root.querySelector('#logo');
                          if(img && settings.logo_path){
                            let absLogo = '';
                            if(String(settings.logo_path).startsWith('assets/')){
                              const rp = await api.resolve_path(settings.logo_path);
                              if(rp && rp.ok){ 
                                absLogo = 'file:///' + String(rp.abs||'').replace(/\\/g,'/'); 
                              }
                            }else{
                              absLogo = 'file:///' + String(settings.logo_path||'').replace(/\\/g,'/');
                            }
                            if(absLogo){ img.src = absLogo; }
                          }
                        }catch(_){ }

                        const html = '<!doctype html>' + root.outerHTML;
                        const fname = `invoice-${sale.invoice_no}.pdf`;
                        
                        const pdfResult = await api.pdf_export(html, { 
                          pageSize: 'A4',
                          printBackground: true, 
                          saveMode: 'temp', 
                          filename: fname
                        });
                        
                        if(!pdfResult || !pdfResult.ok){ 
                          false && console.error('âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„Ù„ÙØ§ØªÙˆØ±Ø©');
                          showA4Notification('error', 'âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ù„Ù„ÙØ§ØªÙˆØ±Ø©');
                          return; 
                        }

                        false && console.log('PDF created temporarily at:', pdfResult.path);
                        const company = (settings && settings.seller_legal_name) ? 
                                       settings.seller_legal_name : 'ÙØ§ØªÙˆØ±Ø©';
                        const invNo = String(sale.invoice_no||'');
                        const caption = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${invNo} Ù…Ù† ${company}`;
                        
                        false && console.log('Sending to phone:', rawPhone);
                        
                        // Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ (1-8 Ø«ÙˆØ§Ù†ÙŠ) Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø­Ø¸Ø±
                        false && console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                        await randomDelay(1000, 8000);
                        false && console.log('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                        
                        const sendResult = await api.whatsapp_send_file(
                          rawPhone, 
                          pdfResult.path, 
                          fname, 
                          caption
                        );

                        if(sendResult && sendResult.success){
                          false && console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± WhatsApp Ø¨Ù†Ø¬Ø§Ø­!');
                          showA4Notification('success', 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± WhatsApp Ø¨Ù†Ø¬Ø§Ø­!');
                          
                          try {
                            if(typeof api !== 'undefined' && api.emit_whatsapp_invoice_sent){
                              api.emit_whatsapp_invoice_sent({
                                message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„',
                                invoiceNo: invNo
                              });
                            }
                          } catch(_) {}
                        } else {
                          const errMsg = sendResult?.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                          false && console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', errMsg);
                          showA4Notification('error', 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + errMsg);
                        }
                        
                        try {
                          await api.file_delete(pdfResult.path);
                          false && console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª');
                        } catch(_) {}

                      }catch(e){ 
                        false && console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', e);
                        showA4Notification('error', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (e.message || e));
                      } finally {
                        window.__WA_SENDING__ = false;
                      }
                    })();

                  }catch(e){ 
                    false && console.error('WhatsApp validation error:', e);
                    showA4Notification('error', 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª WhatsApp: ' + (e.message || e)); 
                  }
                })();
              });
            }
          }catch(_){ }

          // Fit-to-one-page: scale down slightly if content just exceeds one page height
          function __fitOnePageIfSlightOverflow(){
            try{
              const page = document.querySelector('.page');
              if(!page) return;
              // Reset previous transform then measure
              page.style.transformOrigin = 'top center';
              page.style.transform = '';
              // A4 usable height = 297mm - (top+bottom margins) = 297 - (10+8) = 279mm
              const pxPerMm = 96/25.4; // CSS px per mm
              const maxHeightPx = 279 * pxPerMm;
              const contentHeight = page.scrollHeight; // total content height
              if(contentHeight <= maxHeightPx) return; // already fits
              const scale = maxHeightPx / contentHeight;
              // Apply only if overflow is small (<= ~14%). Otherwise let it spill to page 2.
              if(scale >= 0.8 && scale < 1){
                page.style.transform = 'scale(' + scale.toFixed(3) + ')';
              } else {
                page.style.transform = '';
              }
            }catch(_){ /* ignore */ }
          }
          // Re-fit on resize and beforeprint to account for preview and printer metrics
          window.addEventListener('resize', () => { try{ __fitOnePageIfSlightOverflow(); }catch(_){ } });
          window.addEventListener('beforeprint', () => { try{ __adjustNumCells(); __fitOnePageIfSlightOverflow(); }catch(_){ } });
          // Initial fit after layout settles
          requestAnimationFrame(() => { try{ __fitOnePageIfSlightOverflow(); }catch(_){ } });

          const __FAST_NO_VAT__ = Number(settings?.vat_percent||0) === 0;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
          try{
            const errors = [];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            if(!sale.invoice_no || String(sale.invoice_no).trim() === ''){
              errors.push('Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
            if(!sale.created_at){
              errors.push('Ø§Ù„ØªØ§Ø±ÙŠØ®');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            if(!sale.payment_method || String(sale.payment_method).trim() === ''){
              errors.push('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª
            if(!items || items.length === 0){
              errors.push('Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const isCreditDoc = String(sale.doc_type||'')==='credit_note' || String(sale.invoice_no||'').startsWith('CN-');
            const afterDiscForGrand = Number(sale.total_after_discount ?? (Number(sale.sub_total||0) - Number(sale.discount_amount||0) + Number(sale.tobacco_fee||0)));
            const computedGrand = Number(sale.grand_total ?? (afterDiscForGrand + Number(sale.vat_total||0)));
            const grandCheck = isCreditDoc ? Math.abs(computedGrand) : computedGrand;
            if(!(grandCheck >= 0)){
              errors.push('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ¹Ø¯Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            if(errors.length > 0){
              const errorMsg = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©:\n\n' + errors.map(e => 'â€¢ ' + e).join('\n');
              document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: 'Cairo', sans-serif;">
                  <div style="max-width: 500px; margin: 0 auto; background: #fee; border: 2px solid #c33; border-radius: 12px; padding: 30px;">
                    <h2 style="color: #c33; margin-bottom: 20px;">âš ï¸ ØªØ­Ø°ÙŠØ±</h2>
                    <div style="white-space: pre-wrap; font-size: 16px; color: #333; line-height: 1.8; text-align: right;">
                      ${errorMsg}
                    </div>
                    <div style="margin-top: 30px; font-size: 14px; color: #666;">
                      ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    </div>
                    <button onclick="window.close()" style="margin-top: 20px; padding: 12px 30px; background: #0b3daa; color: white; border: 0; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                      Ø¥ØºÙ„Ø§Ù‚
                    </button>
                  </div>
                </div>
              `;
              false && console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©:', errors);
              return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            }
          }catch(e){
            false && console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
            try{ window.__CONTENT_READY__ = false; }catch(_){ }
            return;
          }

          // Ø¥Ø¹Ù„Ø§Ù… main.js Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµØ§Ù…ØªØ© (Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ DOM)
          try{ window.__CONTENT_READY__ = false; }catch(_){ }
          try{
            let __t = 0;
            const __max = 350;
            const __step = () => {
              try{
                const invNoEl = document.getElementById('invNo');
                const invDateEl = document.getElementById('invDate');
                const invPayEl = document.getElementById('invPay');
                const tbody = document.querySelector('table tbody');
                const ok = Boolean(
                  invNoEl && invNoEl.textContent && invNoEl.textContent.trim() &&
                  invDateEl && invDateEl.textContent && invDateEl.textContent.trim() &&
                  invPayEl && invPayEl.textContent && invPayEl.textContent.trim() &&
                  tbody && tbody.children && tbody.children.length > 0
                );
                if(ok){
                  try{ window.__CONTENT_READY__ = true; }catch(_){ }
                  return;
                }
              }catch(_){ }
              if(__t >= __max){ return; }
              __t += 25;
              setTimeout(() => {
                try{ requestAnimationFrame(__step); }catch(_){ __step(); }
              }, 25);
            };
            requestAnimationFrame(() => {
              requestAnimationFrame(__step);
            });
          }catch(_){ }
          
          // ğŸš€ Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 800ms)
          const MAX_WAIT = 800;
          const CHECK_INTERVAL = 50;
          const startTime = Date.now();
          
          function checkDataReady(){
            const invNoEl = document.getElementById('invNo');
            const invDateEl = document.getElementById('invDate');
            const invPayEl = document.getElementById('invPay');
            const tbody = document.querySelector('table tbody');
            
            return invNoEl?.textContent?.trim() &&
                   invDateEl?.textContent?.trim() &&
                   invPayEl?.textContent?.trim() &&
                   tbody?.children?.length > 0;
          }
          
          function executePrint(){
            const elapsed = Date.now() - startTime;
            false && console.log(`ğŸ–¨ï¸ [${Date.now()}] Data ready after ${elapsed}ms`);
            
            const invNoEl = document.getElementById('invNo');
            const invDateEl = document.getElementById('invDate');
            const invPayEl = document.getElementById('invPay');
            const tbody = document.querySelector('table tbody');
            
            const domErrors = [];
            if(!invNoEl || !invNoEl.textContent.trim()){
              domErrors.push('Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©');
            }
            if(!invDateEl || !invDateEl.textContent.trim()){
              domErrors.push('Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©');
            }
            if(!invPayEl || !invPayEl.textContent.trim()){
              domErrors.push('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù… ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©');
            }
            if(!tbody || tbody.children.length === 0){
              domErrors.push('Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù… ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©');
            }
            
            if(domErrors.length > 0){
              false && console.error('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† DOM:', domErrors);
              alert('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:\n' + domErrors.join('\n'));
              return;
            }
            
            try{ __fitOnePageIfSlightOverflow(); }catch(_){ }
            if(!(settings && settings.silent_print)){
              false && console.log(`ğŸ–¨ï¸ [${Date.now()}] Calling window.print() now`);
              window.print();
            }
          }
          
          const checkInterval = setInterval(() => {
            if(checkDataReady()){
              clearInterval(checkInterval);
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  executePrint();
                });
              });
            } else if(Date.now() - startTime >= MAX_WAIT){
              clearInterval(checkInterval);
              false && console.warn(`âš ï¸ [${Date.now()}] Max wait time reached (${MAX_WAIT}ms), printing anyway`);
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  executePrint();
                });
              });
            }
          }, CHECK_INTERVAL);

          // Check and notify parent window about WhatsApp status
          try{
            if(settings && settings.whatsapp_on_print){
              const urlParams = new URLSearchParams(window.location.search);
              const isReprint = urlParams.get('reprint') === '1';
              
              if(!isReprint){
                (async () => {
                  try{
                    if(!navigator.onLine){
                      if(window.opener && typeof window.opener.showWhatsAppErrorNotification === 'function'){
                        window.opener.showWhatsAppErrorNotification('no-internet', 'Ù„Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨');
                      }
                    } else {
                      const statusCheck = await api.whatsapp_status();
                      if(!statusCheck || !statusCheck.success || !statusCheck.connected){
                        if(window.opener && typeof window.opener.showWhatsAppErrorNotification === 'function'){
                          window.opener.showWhatsAppErrorNotification('not-connected', 'Ù„Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨');
                        }
                      }
                    }
                  }catch(_){}
                })();
              }
            }
          }catch(_){}

          // Auto-send PDF to WhatsApp after manual print completes
          try{
            if(settings && settings.whatsapp_on_print){
              const urlParams = new URLSearchParams(window.location.search);
              const copyNumber = urlParams.get('copy');
              const isReprint = urlParams.get('reprint') === '1';
              const isFirstCopy = !copyNumber || copyNumber === '1';
              
              if(isReprint){
                false && console.log('â­ï¸ Skipping WhatsApp afterprint handler for reprint');
              } else if(!isFirstCopy){
                false && console.log(`â­ï¸ Skipping WhatsApp afterprint handler for copy #${copyNumber}`);
              } else {
                const timestamp = Date.now();
                false && console.log(`ğŸ”§ [${timestamp}] Registering WhatsApp afterprint handler (copy #${copyNumber || '1'})`);
                
                window.addEventListener('afterprint', async () => {
                const eventTime = Date.now();
                false && console.log(`ğŸ”” [${eventTime}] afterprint event fired! (${eventTime - timestamp}ms after registration)`);
                
                if(window.__WA_SENT__ || window.__WA_SENDING__){
                  false && console.log(`â­ï¸ [${eventTime}] WhatsApp send already in progress or completed, skipping (SENT=${window.__WA_SENT__}, SENDING=${window.__WA_SENDING__})`);
                  return;
                }
                
                window.__WA_SENDING__ = true;
                window.__WA_SENT__ = true;
                false && console.log(`â³ [${eventTime}] Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...`);
                
                try{
                  if(!navigator.onLine){
                    console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨');
                    if(typeof window.showWhatsAppErrorNotification === 'function'){
                      window.showWhatsAppErrorNotification('no-internet', 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹');
                    }
                    window.__WA_SENDING__ = false;
                    window.__WA_SENT__ = false;
                    return;
                  }

                  const statusCheck = await api.whatsapp_status();
                  if(!statusCheck || !statusCheck.success || !statusCheck.connected){
                    console.error('âŒ WhatsApp not connected, skipping auto-send');
                    if(typeof window.showWhatsAppErrorNotification === 'function'){
                      window.showWhatsAppErrorNotification('not-connected', 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹');
                    }
                    window.__WA_SENDING__ = false;
                    window.__WA_SENT__ = false;
                    return;
                  }

                  let rawPhone = String(sale.customer_phone || '').trim();
                  if(/^05\d{8}$/.test(rawPhone)){ 
                    rawPhone = '966' + rawPhone.slice(1); 
                  }
                  rawPhone = rawPhone.replace(/[^\d+]/g,'');
                  if(!rawPhone){ 
                    false && console.log('âŒ No customer phone, skipping WhatsApp send');
                    window.__WA_SENDING__ = false;
                    window.__WA_SENT__ = false;
                    return; 
                  }

                  false && console.log(`ğŸ“„ [${Date.now()}] Creating PDF for invoice... (invoice_no: ${sale.invoice_no})`);
                  const root = document.documentElement.cloneNode(true);
                  Array.from(root.querySelectorAll('script')).forEach(s=>s.remove());
                  Array.from(root.querySelectorAll('.reprint-btn, .export-btn, .whats-btn')).forEach(el=>el.remove());
                  
                  try{
                    const img = root.querySelector('#logo');
                    if(img && settings.logo_path){
                      let absLogo = '';
                      if(String(settings.logo_path).startsWith('assets/')){
                        const rp = await api.resolve_path(settings.logo_path);
                        if(rp && rp.ok){ 
                          absLogo = 'file:///' + String(rp.abs||'').replace(/\\/g,'/'); 
                        }
                      }else{
                        absLogo = 'file:///' + String(settings.logo_path||'').replace(/\\/g,'/');
                      }
                      if(absLogo){ img.src = absLogo; }
                    }
                  }catch(_){ }

                  const html = '<!doctype html>' + root.outerHTML;
                  const fname = `invoice-${sale.invoice_no}.pdf`;
                  
                  false && console.log(`ğŸ“ [${Date.now()}] Generating PDF with filename: ${fname}`);
                  const pdfResult = await api.pdf_export(html, { 
                    pageSize: 'A4',
                    printBackground: true, 
                    saveMode: 'temp', 
                    filename: fname
                  });
                  
                  if(!pdfResult || !pdfResult.ok){ 
                    false && console.error('âŒ Failed to generate PDF for auto-send');
                    window.__WA_SENDING__ = false;
                    window.__WA_SENT__ = false;
                    return; 
                  }

                  false && console.log(`âœ… [${Date.now()}] PDF generated at: ${pdfResult.path}`);
                  const company = (settings && settings.seller_legal_name) ? 
                                 settings.seller_legal_name : 'ÙØ§ØªÙˆØ±Ø©';
                  const invNo = String(sale.invoice_no||'');
                  const caption = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${invNo} Ù…Ù† ${company}`;
                  
                  false && console.log(`ğŸ“¤ [${Date.now()}] Sending PDF via WhatsApp to: ${rawPhone}`);
                  false && console.log(`ğŸ“¤ [${Date.now()}] File path: ${pdfResult.path}`);
                  false && console.log(`ğŸ“¤ [${Date.now()}] File name: ${fname}`);
                  
                  // Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ (1-8 Ø«ÙˆØ§Ù†ÙŠ) Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø­Ø¸Ø±
                  false && console.log(`â³ [${Date.now()}] Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...`);
                  await randomDelay(1000, 8000);
                  false && console.log(`âœ… [${Date.now()}] Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...`);
                  
                  const sendResult = await api.whatsapp_send_file(
                    rawPhone, 
                    pdfResult.path, 
                    fname, 
                    caption
                  );

                  if(sendResult && sendResult.success){
                    console.log(`âœ… [${Date.now()}] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù†Ø¬Ø§Ø­!`);
                    
                    try {
                      if(typeof api !== 'undefined' && api.emit_whatsapp_invoice_sent){
                        api.emit_whatsapp_invoice_sent({
                          message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„',
                          invoiceNo: invNo
                        });
                      }
                    } catch(_) {}
                  } else {
                    const errorMsg = sendResult?.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    console.error(`âŒ [${Date.now()}] ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:`, errorMsg);
                    if(typeof window.showWhatsAppErrorNotification === 'function'){
                      const reason = errorMsg.includes('not connected') || errorMsg.includes('ØºÙŠØ± Ù…ØªØµÙ„') ? 'not-connected' : 'no-internet';
                      window.showWhatsAppErrorNotification(reason, 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ' + errorMsg);
                    }
                  }
                  
                  false && console.log(`ğŸ—‘ï¸ [${Date.now()}] Cleaning up temp file...`);
                  try {
                    await api.file_delete(pdfResult.path);
                    false && console.log(`âœ… [${Date.now()}] Temp file deleted`);
                  } catch(_) {
                    false && console.log(`âš ï¸ [${Date.now()}] Failed to delete temp file`);
                  }
                }catch(e){ 
                  const errorMsg = e?.message || String(e);
                  console.error(`âŒ [${Date.now()}] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨:`, e);
                  if(typeof window.showWhatsAppErrorNotification === 'function'){
                    const reason = errorMsg.includes('not connected') || errorMsg.includes('ØºÙŠØ± Ù…ØªØµÙ„') ? 'not-connected' : 'no-internet';
                    window.showWhatsAppErrorNotification(reason, 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ' + errorMsg);
                  }
                  window.__WA_SENDING__ = false;
                  window.__WA_SENT__ = false;
                }finally{
                  false && console.log(`ğŸ [${Date.now()}] WhatsApp send handler finished`);
                  window.__WA_SENDING__ = false;
                }
              }, { once: true });
              }
            }
          }catch(_){ /* ignore */ }

        }catch(e){
          document.body.innerHTML = '<div style="padding:12px">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© A4</div>';
        }
      })();
    </script>
  </body>
</html>