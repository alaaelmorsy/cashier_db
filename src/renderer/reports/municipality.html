<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>تقرير البلدية</title>
    <style>
      :root{ --bg:#f6f8fb; --card:#ffffff; --border:#e6eaf0; --text:#0f172a; --muted:#64748b; --brand:#0b3daa; }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Arial, sans-serif; background:var(--bg); margin:0; color:var(--text)}
      header{position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center; justify-content:space-between; background:var(--card); padding:12px 16px; border-bottom:1px solid var(--border)}
      .title{font-weight:700}
      .toolbar{display:flex; gap:8px}
      .btn{padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer}
      .container{max-width:1200px; margin:16px auto; padding:0 12px}
      .muted{color:var(--muted)}
      .range-bar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0}
      .range-actions{display:flex; gap:8px}
      .range-inputs{display:flex; gap:8px; align-items:center}
      .input{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:8px}
      .section{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin:12px 0}
      .section h3{margin:0 0 8px; font-size:16px}
      table{width:100%; border-collapse:collapse}
      thead{ display: table-header-group }
      th,td{padding:10px; border-bottom:1px solid var(--border); text-align:right}
      th{background:#eef2ff; color:var(--brand); font-weight:600}
      /* Detail grouping card to distinguish from other invoices */
      .detail-card{ background:#fff; border:1px solid var(--border); border-inline-start:4px solid var(--brand); border-radius:10px; padding:10px; margin:10px 0; box-shadow:0 6px 16px rgba(15,23,42,.06); break-inside: avoid; page-break-inside: avoid }
      .detail-card.credit{ border-inline-start-color:#ef4444 }
      .inv-summary{ margin-bottom:8px }

      /* Print styles for better PDF fit */
      @media print{
        @page{ size: A4 portrait; margin: 10mm }
        body{ background:#fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 12px }
        header{ position: static; border-bottom: none; padding: 0 0 8px 0 }
        .toolbar, .range-actions, #exportPdfBtn, #exportExcelBtn, #toggleAllOpen, #toggleAllClose, #applyRangeBtn, #btnBack, .inv-summary .btn, button[data-view]{ display:none !important }
        .container{ max-width: none; margin: 0; padding: 0 4mm }
        .section{ background: #fff; border: none; border-radius: 0; padding: 0; margin: 0 }
        th,td{ padding:6px; font-size: 11px }
        .inv-summary{ margin: 6px 0; padding:6px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px }
        .detail-card{ box-shadow: none; margin: 8px 0; border-inline-start-width: 3px }
      }

      @media (max-width: 640px){ .btn{padding:8px 10px} th,td{padding:8px} .range-bar{flex-direction:column; align-items:stretch} .range-actions{justify-content:space-between} }

      /* Company banner (print-only) */
      .company-banner{ display:none; align-items:center; gap:12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:12px 0 }
      .company-banner img{ max-height:60px; max-width:160px; object-fit:contain }
      .company-banner .name{ font-weight:700; font-size:16px }
      .company-banner .info{ display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:6px; font-size:12px }
      .company-banner .label{ color: var(--muted); margin-inline-start:6px }

      /* Print-only visibility and better PDF fit */
      @media print{
        tfoot{ display: table-row-group !important }
        .company-banner{ display:flex !important; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px; margin: 0 0 8px 0 }
      }
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-Regular.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
      }
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-Medium.ttf') format('truetype');
        font-weight: 500;
        font-display: swap;
      }
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-SemiBold.ttf') format('truetype');
        font-weight: 600;
        font-display: swap;
      }
      @font-face{
        font-family: 'Cairo';
        src: url('../../../assets/fonts/Cairo-Bold.ttf') format('truetype');
        font-weight: 700;
        font-display: swap;
      }
      @font-face{
        font-family: 'saudi_riyal';
        src: url('../../../assets/fonts/saudi-riyal.woff') format('woff'),
             url('../../../assets/fonts/saudi-riyal.ttf') format('truetype');
        font-display: swap;
        unicode-range: U+E900;
      }
      :root{ --m-left: 0mm; --m-right: 0mm; }
      @media print{
        @page{ margin-left: 8mm; margin-right: 8mm; }
        body{ padding-left: var(--m-left); padding-right: var(--m-right); }
        *, *::before, *::after{
          font-family: 'saudi_riyal', system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Arial, sans-serif !important;
          font-weight: 800 !important;
          color: #0f172a !important;
          font-size: 14px !important;
        }
      }
      
      /* Dark Mode Support */
      @media screen {
        body.dark {
          --bg: #0d0d0d;
          --card: #1a1a1a;
          --border: #333333;
          --text: #ffffff;
          --muted: #9ca3af;
          --brand: #3b82f6;
          background: var(--bg);
          color: var(--text);
        }
        body.dark header { background: var(--card); border-bottom-color: var(--border); }
        body.dark .section { background: var(--card); border-color: var(--border); }
        body.dark .kpi { background: var(--card); border-color: var(--border); }
        body.dark .kpi .value { color: var(--brand); }
        body.dark .kpi .label { color: var(--muted); }
        body.dark th { background: #1a2744; color: #93c5fd; }
        body.dark td { color: var(--text); border-bottom-color: var(--border); }
        body.dark table { border-color: var(--border); }
        body.dark .summary-item { background: var(--card); border-color: var(--border); color: var(--text); }
        body.dark .input { background: #1a1a1a; border-color: var(--border); color: var(--text); }
        body.dark .input:focus { border-color: #3b82f6; }
        body.dark label { color: var(--text); }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">تقرير البلدية (فواتير تحتوي رسوم تبغ)</div>
      <div class="toolbar">
        <button id="btnBack" class="btn">الرجوع</button>
      </div>
    </header>

    <div class="container">
      <div id="companyBanner" class="company-banner">
        <img id="companyLogo" alt="logo" style="display:none"/>
        <div>
          <div class="name" id="companyName"></div>
          <div class="info">
            <div><span class="label">الجوال:</span> <span id="companyMobile"></span></div>
            <div><span class="label">العنوان:</span> <span id="companyAddress"></span></div>
            <div><span class="label">الرقم الضريبي:</span> <span id="companyVat"></span></div>
          </div>
        </div>
      </div>

      <div class="range-bar">
        <div class="range-inputs">
          <label for="fromAt">من:</label>
          <input id="fromAt" class="input" type="datetime-local" />
          <label for="toAt">إلى:</label>
          <input id="toAt" class="input" type="datetime-local" />
          <label class="muted" style="margin-inline-start:8px"><input type="checkbox" id="excludeCn" /> استبعاد إشعارات الدائن</label>
          <button id="applyRangeBtn" class="btn">تطبيق</button>
        </div>
        <div class="range-actions">
          <button id="exportPdfBtn" class="btn">تصدير PDF</button>
          <button id="exportExcelBtn" class="btn">تصدير Excel</button>

        </div>
      </div>
      <div class="muted" id="range"></div>

      <div class="section">
        <h3>الفواتير المحتوية على رسوم تبغ</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>رقم الفاتورة</th>
                <th>طريقة الدفع</th>
                <th>المجموع</th>
                <th>الخصم</th>
                <th>الضريبة</th>
                <th>رسوم التبغ</th>
                <th>الإجمالي</th>
                <th>تاريخ الدفع</th>
                <th>عرض</th>
                <th>تفاصيل</th>
              </tr>
            </thead>
            <tbody id="invTbody"></tbody>

          </table>
        </div>
      </div>

      <div class="section">
        <details open>
          <summary>ملخص أصناف التبغ</summary>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>المنتج</th>
                  <th>العملية</th>
                  <th>سعر المنتج</th>
                  <th>الكمية</th>
                  <th class="right">الإجمالي</th>
                </tr>
              </thead>
              <tbody id="tobaccoSummaryRows"></tbody>
            </table>
          </div>
        </details>
      </div>

      <div class="section">
        <h3>الإجماليات</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th colspan="3"></th>
                <th class="muted">المجموع</th>
                <th class="muted">الخصم</th>
                <th class="muted">الضريبة</th>
                <th class="muted">رسوم التبغ</th>
                <th class="muted">الإجمالي</th>
                <th class="muted">العدد</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th colspan="3">إجمالي الفواتير</th>
                <th id="sumSubInv">0.00</th>
                <th id="sumDiscInv">0.00</th>
                <th id="sumVatInv">0.00</th>
                <th id="sumTobInv">0.00</th>
                <th id="sumGrandInv">0.00</th>
                <th id="sumCountInv">0</th>
              </tr>
              <tr>
                <th colspan="3">إجمالي إشعارات الدائن</th>
                <th id="sumSubCN">0.00</th>
                <th id="sumDiscCN">0.00</th>
                <th id="sumVatCN">0.00</th>
                <th id="sumTobCN">0.00</th>
                <th id="sumGrandCN">0.00</th>
                <th id="sumCountCN">0</th>
              </tr>
              <tr>
                <th colspan="3">الصافي</th>
                <th id="sumSub">0.00</th>
                <th id="sumDisc">0.00</th>
                <th id="sumVat">0.00</th>
                <th id="sumTob">0.00</th>
                <th id="sumGrand">0.00</th>
                <th id="sumCount">0</th>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      // إخفاء زر العودة إذا كان هناك زر الرجوع
      window.addEventListener('DOMContentLoaded', function() {
        const btnBack = document.getElementById('btnBack');
        if (btnBack) {
          document.querySelectorAll('a, button').forEach(function(el) {
            if (el !== btnBack && el.textContent.includes('العودة')) {
              el.style.display = 'none';
            }
          });
        }
      });
    </script>
    <script src="./print-margins.js"></script>
    <script src="./municipality.js"></script>
  </body>
</html>